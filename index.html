<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeOS V99 - Market Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        /* --- FOND V90 (VIOLET/NOIR) --- */
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #050505; background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%); color: #fff; -webkit-font-smoothing: antialiased; min-height: 100vh; }
        .glass-base { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(40px); border: 1px solid rgba(255, 255, 255, 0.05); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border-radius: 2rem; }
        
        /* --- HERO CARD : RECOMMANDATION DU JOUR --- */
        .reco-container {
            margin-bottom: 2rem;
            display: none; /* CachÃ© par dÃ©faut */
            animation: slideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .reco-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(6, 78, 59, 0.05) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 1.5rem;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px -10px rgba(16, 185, 129, 0.3);
        }
        .reco-card::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shine 3s infinite;
        }
        .reco-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;
        }
        .reco-badge {
            background: #10b981; color: #000; padding: 4px 12px; border-radius: 20px;
            font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shine { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }

        /* --- RECHERCHE & CLOCHE STYLE (COINBASE LIKE) --- */
        .pro-search-input { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 16px 20px; color: white; font-family: 'JetBrains Mono', monospace; font-size: 1rem; transition: 0.3s; }
        .pro-search-input:focus { border-color: #3b82f6; box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); outline: none; }
        
        .autocomplete-items { position: absolute; border: 1px solid #333; border-top: none; z-index: 99; top: 100%; left: 0; right: 0; background-color: #09090b; border-radius: 0 0 12px 12px; max-height: 350px; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.9); }
        .autocomplete-item { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .autocomplete-item:hover { background-color: rgba(255, 255, 255, 0.03); }
        
        .bell-btn { width: 36px; height: 36px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; background: rgba(0,0,0,0.3); color: #6b7280; }
        .bell-btn:hover { background: rgba(59, 130, 246, 0.1); color: #3b82f6; border-color: #3b82f6; }
        .bell-active { background: #3b82f6 !important; color: white !important; border-color: #3b82f6 !important; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }

        /* --- TOAST NOTIFICATION --- */
        #toast { visibility: hidden; min-width: 250px; background-color: #3b82f6; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 999; left: 50%; bottom: 30px; transform: translateX(-50%); box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-weight: bold; font-size: 0.9rem; opacity: 0; transition: opacity 0.5s, bottom 0.5s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        /* --- CLASSIC UI --- */
        .flow-card { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.03); border-radius: 1.5rem; padding: 1.5rem; cursor: pointer; }
        .timeline-row { display: flex; gap: 1.5rem; position: relative; padding-bottom: 2rem; }
        .timeline-line { position: absolute; left: 63px; top: 20px; bottom: -20px; width: 2px; background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(255,255,255,0.02)); }
        .timeline-time { width: 50px; text-align: right; font-family: monospace; font-size: 0.85rem; font-weight: 700; opacity: 0.6; padding-top: 1.5rem; }
        .timeline-dot { position: absolute; left: 58px; top: 28px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #000; z-index: 10; }
        
        .dot-task { background: #3b82f6; } .accent-task { border-left: 3px solid #3b82f6; }
        .dot-important { background: #ef4444; box-shadow: 0 0 20px #ef4444; animation: pulseRed 2s infinite; }
        .accent-important { border-left: 3px solid #ef4444; background: linear-gradient(90deg, rgba(239,68,68,0.1), transparent); }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .glass-panel { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1rem; overflow: hidden; backdrop-filter: blur(10px); }
        .watchlist-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; }
        .watchlist-item:hover { background: rgba(255,255,255,0.05); }
        .nav-active { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: white; }
        .nav-btn { color: #9ca3af; } .nav-btn:hover { color: white; }
        .day { aspect-ratio: 1; border-radius: 0.8rem; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer; transition: 0.2s; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); }
        .day-today { color: #60a5fa; font-weight: 800; border-color: #60a5fa; }
        .day-selected { background: white !important; color: black !important; font-weight: 900; box-shadow: 0 0 15px rgba(255,255,255,0.3); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="toast">ðŸ”” Alerte ActivÃ©e avec succÃ¨s !</div>

    <div class="max-w-[1700px] mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <aside class="lg:col-span-3 flex flex-col gap-6 h-[calc(100vh-4rem)] sticky top-8">
            <div class="glass-base p-8 space-y-6 flex-1 flex flex-col">
                <div class="flex justify-between items-center"><h1 class="text-2xl font-bold tracking-tight">Life<span class="text-blue-500 italic">OS</span></h1></div>
                <div class="grid grid-cols-2 gap-2 bg-black/20 p-1 rounded-2xl">
                    <button onclick="switchView('planning')" id="nav-planning" class="nav-btn nav-active py-2 rounded-xl text-xs font-bold transition-all">ðŸ“… Planning</button>
                    <button onclick="switchView('market')" id="nav-market" class="nav-btn py-2 rounded-xl text-xs font-bold transition-all">ðŸ“ˆ Bourse</button>
                </div>
                <div><p class="text-[9px] font-bold uppercase tracking-widest text-zinc-500 mb-2">Calendrier</p><div id="calendar" class="grid grid-cols-7 gap-1"></div></div>
                <div class="flex-1">
                    <p class="text-[9px] font-bold uppercase tracking-widest text-zinc-500 mb-2">Assistant IA</p>
                    <textarea id="userInput" class="w-full bg-black/20 border border-white/5 rounded-2xl p-4 text-sm outline-none resize-none h-32" placeholder="Fonction IA dÃ©sactivÃ©e dans cette dÃ©mo..."></textarea>
                </div>
            </div>
        </aside>

        <main class="lg:col-span-9 space-y-6 pb-10">
            
            <div id="view-planning" class="glass-base p-8 md:p-10 transition-colors duration-500">
                
                <div id="market-hero" class="reco-container"></div>

                <div class="flex flex-col md:flex-row justify-between md:items-end mb-6 pb-6 gap-6">
                    <div>
                        <div class="flex items-center gap-2 mb-2"><span id="dayIndicator" class="w-2 h-2 rounded-full bg-blue-500"></span><span class="text-[10px] font-bold uppercase tracking-widest opacity-60">Planning Live</span></div>
                        <h2 id="hudDate" class="text-4xl font-black tracking-tight text-white">Date</h2>
                    </div>
                </div>

                <div class="relative pl-4 pt-4"><div id="masterTimeline"></div></div>
            </div>

            <div id="view-market" class="hidden flex flex-col gap-6">
                
                <div class="glass-panel p-2">
                    <div class="tradingview-widget-container">
                        <div class="tradingview-widget-container__widget"></div>
                        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
                        { "symbols": [ {"proName": "FOREXCOM:SPXUSD", "title": "S&P 500"}, {"proName": "BITSTAMP:BTCUSD", "title": "Bitcoin"}, {"proName": "TVC:GOLD", "title": "Or"} ], "showSymbolLogo": true, "colorTheme": "dark", "isTransparent": true, "displayMode": "adaptive", "locale": "fr" }
                        </script>
                    </div>
                </div>

                <div class="relative">
                    <input id="pf-symbol" type="text" class="pro-search-input" placeholder="ðŸ” Rechercher une action, crypto, ETF pour activer l'alerte..." autocomplete="off">
                    <div id="autocomplete-list" class="autocomplete-items hidden"></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
                    <div class="lg:col-span-8 flex flex-col gap-4">
                        <div class="glass-panel p-1 h-[500px] border border-white/10 relative">
                            <div class="absolute top-2 left-4 z-10 bg-black/50 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-widest text-blue-400" id="activeChartLabel">Analyse</div>
                            <div class="tradingview-widget-container" style="height:100%;width:100%"><div id="tv_main_chart" style="height:100%;width:100%"></div></div>
                        </div>
                        <div class="glass-panel p-4 flex flex-col h-[300px]">
                            <h3 class="text-xs font-bold uppercase text-zinc-500 mb-3 tracking-widest">Mes Alertes Actives</h3>
                            <div id="watchlist" class="flex-1 overflow-y-auto space-y-1"></div>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-4 flex flex-col gap-4">
                        <div class="glass-panel p-2 h-[200px] flex flex-col">
                            <h3 class="text-[10px] font-bold uppercase text-center text-yellow-400 mb-1">Jauge Technique</h3>
                            <div class="flex-1 tradingview-widget-container" style="height:100%;width:100%"><div id="tv_gauge" style="height:100%;width:100%"></div></div>
                        </div>
                         <div class="glass-panel p-2 h-[300px] flex flex-col">
                             <h3 class="text-[10px] font-bold uppercase text-center text-blue-400 mb-1">Agenda Ã‰co</h3>
                             <div class="tradingview-widget-container" style="height:100%;width:100%"><div class="tradingview-widget-container__widget"></div><script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-events.js" async>{ "colorTheme": "dark", "isTransparent": true, "width": "100%", "height": "100%", "locale": "fr", "importanceFilter": "0,1", "currencyFilter": "USD,EUR" }</script></div>
                        </div>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <script>
        // --- CONFIG ---
        // TON LIEN GOOGLE APPS SCRIPT
        const API_URL = "https://script.google.com/macros/s/AKfycbyKK3V8CMpGAFBLaKjE1GUSGcM5MGMSsUT7sRJ4rlmr9jRuJKbkZs7Vj17--goeOdGt/exec";
        
        let db = JSON.parse(localStorage.getItem('lifeos_v70_db') || "{}");
        let watchlist = JSON.parse(localStorage.getItem('lifeos_watchlist') || "[]");
        let currentChartSymbol = "TVC:CAC40";
        const now = new Date(); const todayNum = now.getDate(); const monthNames = ["Jan", "FÃ©v", "Mar", "Avr", "Mai", "Juin", "Juil", "AoÃ»t", "Sep", "Oct", "Nov", "DÃ©c"]; 

        // --- BASE DE DONNÃ‰ES MASSIVE (TOP 200 PRO) ---
        const hugeStockDatabase = [
            // INDICES & ETF
            { l: "S&P 500 (ETF)", s: "NYSEARCA:VOO", i: "Index" }, { l: "NASDAQ 100 (ETF)", s: "NASDAQ:QQQ", i: "Index" },
            { l: "Amundi MSCI World", s: "EPA:CW8", i: "ETF PEA" }, { l: "Amundi S&P 500", s: "EPA:ESE", i: "ETF PEA" },
            { l: "Lyxor CAC 40", s: "EPA:CAC", i: "ETF PEA" }, { l: "Vanguard Total World", s: "NYSEARCA:VT", i: "ETF" },
            
            // CRYPTO (Majors)
            { l: "Bitcoin USD", s: "BITSTAMP:BTCUSD", i: "Crypto" }, { l: "Ethereum USD", s: "BITSTAMP:ETHUSD", i: "Crypto" },
            { l: "Solana USD", s: "BITSTAMP:SOLUSD", i: "Crypto" }, { l: "XRP USD", s: "BITSTAMP:XRPUSD", i: "Crypto" },
            { l: "Cardano", s: "BITSTAMP:ADAUSD", i: "Crypto" }, { l: "Dogecoin", s: "BITSTAMP:DOGEUSD", i: "Crypto" },
            
            // TECH US (Magnificent 7 + others)
            { l: "Apple Inc", s: "NASDAQ:AAPL", i: "Tech" }, { l: "Microsoft Corp", s: "NASDAQ:MSFT", i: "Tech" },
            { l: "Nvidia Corp", s: "NASDAQ:NVDA", i: "Semicon" }, { l: "Amazon.com", s: "NASDAQ:AMZN", i: "Retail" },
            { l: "Meta Platforms", s: "NASDAQ:META", i: "Tech" }, { l: "Tesla Inc", s: "NASDAQ:TSLA", i: "Auto" },
            { l: "Alphabet (Google)", s: "NASDAQ:GOOGL", i: "Tech" }, { l: "Netflix", s: "NASDAQ:NFLX", i: "Media" },
            { l: "AMD", s: "NASDAQ:AMD", i: "Semicon" }, { l: "Intel", s: "NASDAQ:INTC", i: "Semicon" },
            { l: "Palantir", s: "NYSE:PLTR", i: "AI" }, { l: "Coinbase", s: "NASDAQ:COIN", i: "Crypto" },
            
            // FRANCE (CAC 40)
            { l: "LVMH", s: "EPA:MC", i: "Luxe" }, { l: "TotalEnergies", s: "EPA:TTE", i: "Energie" },
            { l: "L'OrÃ©al", s: "EPA:OR", i: "CosmÃ©tique" }, { l: "HermÃ¨s", s: "EPA:RMS", i: "Luxe" },
            { l: "Air Liquide", s: "EPA:AI", i: "Indus" }, { l: "Sanofi", s: "EPA:SAN", i: "SantÃ©" },
            { l: "BNP Paribas", s: "EPA:BNP", i: "Banque" }, { l: "AXA", s: "EPA:CS", i: "Assurance" },
            { l: "Airbus", s: "EPA:AIR", i: "AÃ©ro" }, { l: "Renault", s: "EPA:RNO", i: "Auto" }
        ];

        // --- MOTEUR DE RECHERCHE & CLOCHE ðŸ”” ---
        const inp = document.getElementById("pf-symbol");
        const list = document.getElementById("autocomplete-list");

        inp.addEventListener("input", function(e) {
            const val = this.value.toUpperCase();
            list.innerHTML = ""; list.classList.add('hidden');
            if (!val) return;
            
            const matches = hugeStockDatabase.filter(item => item.l.toUpperCase().includes(val) || item.s.toUpperCase().includes(val));
            
            if (matches.length > 0) {
                list.classList.remove('hidden');
                matches.slice(0, 10).forEach(item => { 
                    const d = document.createElement("DIV");
                    d.className = "autocomplete-item";
                    
                    const isActive = watchlist.some(w => w.s === item.s);
                    const bellClass = isActive ? "bell-btn bell-active" : "bell-btn";

                    d.innerHTML = `
                        <div class="flex items-center gap-3" onclick="loadActiveAsset('${item.s}')" style="cursor:pointer; flex:1">
                            <span class="font-mono font-bold text-blue-400">${item.s}</span>
                            <span class="text-sm opacity-70">${item.l}</span>
                        </div>
                        <button class="${bellClass}" onclick="toggleAlert('${item.s}', '${item.l}', this)">
                            ðŸ””
                        </button>
                    `;
                    list.appendChild(d);
                });
            }
        });
        
        document.addEventListener("click", function (e) { if(e.target !== inp) list.classList.add('hidden'); });

        // --- FONCTION: CLIC SUR LA CLOCHE ---
        function toggleAlert(symbol, name, btnElement) {
            btnElement.classList.add('bell-active');
            
            if(!watchlist.some(item => item.s === symbol)) {
                watchlist.push({s: symbol, l: name});
                localStorage.setItem('lifeos_watchlist', JSON.stringify(watchlist));
                renderWatchlist();
            }

            // ENVOYER Ã€ GOOGLE
            fetch(`${API_URL}?ticker=${symbol}`, { mode: 'no-cors' })
            .then(() => showToast(`Alerte activÃ©e pour ${name}`))
            .catch(e => console.log(e));
        }

        // --- SYNC : INTELLIGENCE ARTIFICIELLE & FAVORIS ---
        async function syncGoogleAgenda() {
            try {
                const reponse = await fetch(`${API_URL}?action=read`);
                const reco = await reponse.json(); 
                const heroContainer = document.getElementById('market-hero');

                if (reco && reco.ticker) {
                    
                    // Style detection
                    const isPortfolio = (reco.type === "PORTFOLIO");
                    const isNegative = reco.percent < 0; 
                    
                    const subtitle = reco.reason; 
                    const icon = isPortfolio ? "ðŸ””" : "ðŸ§ "; 
                    const badgeText = isPortfolio ? "ALERTE FAVORIS" : "DÃ‰COUVERTE IA";
                    
                    const colorTheme = isNegative ? "239, 68, 68" : "16, 185, 129"; // Rouge/Vert
                    const percentSign = reco.percent > 0 ? "+" : "";

                    const bgStyle = `background: linear-gradient(135deg, rgba(${colorTheme}, 0.15), rgba(0,0,0,0)); border-color: rgba(${colorTheme}, 0.4);`;

                    // CONSTRUCTION DE LA CARTE HERO
                    heroContainer.innerHTML = `
                        <div class="reco-card" style="${bgStyle}">
                            <div class="reco-header">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">${icon}</span>
                                    <span class="text-[10px] font-bold uppercase tracking-widest opacity-60">${badgeText}</span>
                                </div>
                                <span class="reco-badge" style="background: rgb(${colorTheme}); color: black;">${percentSign}${reco.percent.toFixed(2)}%</span>
                            </div>
                            <div class="flex justify-between items-end mt-4">
                                <div>
                                    <h3 class="text-3xl font-black text-white leading-tight tracking-tight">
                                        ${reco.ticker.replace("NASDAQ:", "").replace("BITSTAMP:", "")}
                                    </h3>
                                    <p class="text-sm font-bold opacity-80 mt-1" style="color: rgb(${colorTheme});">
                                        ${subtitle}
                                    </p>
                                </div>
                                <div class="text-right">
                                     <button onclick="loadActiveAsset('${reco.ticker}'); switchView('market');" class="bg-white text-black px-6 py-3 rounded-xl font-bold text-xs uppercase hover:scale-105 transition-transform shadow-lg">
                                        Voir l'actif
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    heroContainer.style.display = "block";
                    addMarketTaskToTimeline(reco);

                } else {
                    heroContainer.style.display = "none"; 
                }

            } catch (err) {
                console.log("Aucune recommandation majeure ou erreur rÃ©seau.", err);
            }
        }

        function addMarketTaskToTimeline(reco) {
            if(!db[todayNum]) db[todayNum] = [];
            const shortTxt = `${reco.ticker} (${reco.percent.toFixed(1)}%)`;
            
            if(!db[todayNum].some(t => t.shortText.includes(reco.ticker))) {
                db[todayNum].push({
                    shortText: shortTxt,
                    fullText: `Signal ${reco.type} : ${reco.reason}`,
                    time: "09:00",
                    duration: 15,
                    done: false,
                    isMarket: true
                });
                save();
                renderHUD();
            }
        }

        // --- AFFICHAGE "TOAST" ---
        function showToast(message) {
            var x = document.getElementById("toast");
            x.innerText = "ðŸ”” " + message;
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- MARKET WIDGETS ---
        function refreshMarketWidgets() {
            const container = document.getElementById('tv_main_chart');
            const gauge = document.getElementById('tv_gauge');
            
            // Main Chart
            if(container) {
                container.innerHTML = "";
                new TradingView.widget({ "autosize": true, "symbol": currentChartSymbol, "interval": "D", "timezone": "Europe/Paris", "theme": "dark", "style": "1", "locale": "fr", "toolbar_bg": "#f1f3f6", "enable_publishing": false, "container_id": "tv_main_chart", "hide_side_toolbar": false });
            }
            // Gauge
            if(gauge) {
                 gauge.innerHTML = "";
                 const script = document.createElement('script'); script.type = 'text/javascript'; script.src = "https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js"; script.async = true;
                 script.innerHTML = JSON.stringify({ "interval": "1D", "width": "100%", "isTransparent": true, "height": "100%", "symbol": currentChartSymbol, "showIntervalTabs": false, "displayMode": "single", "locale": "fr", "colorTheme": "dark" });
                 gauge.appendChild(script);
            }
            document.getElementById('activeChartLabel').innerText = `Analyse : ${currentChartSymbol}`;
        }

        function renderWatchlist() {
            const container = document.getElementById('watchlist');
            container.innerHTML = "";
            watchlist.forEach(item => {
                const div = document.createElement('div');
                div.className = "watchlist-item group";
                div.onclick = () => { loadActiveAsset(item.s); };
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-blue-400 font-bold">ðŸ””</span>
                        <div><p class="font-bold text-sm">${item.s}</p><p class="text-[10px] opacity-50">${item.l}</p></div>
                    </div>
                    <button onclick="event.stopPropagation(); removeFromWatchlist('${item.s}')" class="text-red-500 opacity-50 hover:opacity-100 text-xs">Retirer</button>
                `;
                container.appendChild(div);
            });
        }

        function loadActiveAsset(symbol) { currentChartSymbol = symbol; refreshMarketWidgets(); }
        function removeFromWatchlist(symbol) { watchlist = watchlist.filter(item => item.s !== symbol); localStorage.setItem('lifeos_watchlist', JSON.stringify(watchlist)); renderWatchlist(); }
        function switchView(viewName) { 
            const plan = document.getElementById('view-planning'); const market = document.getElementById('view-market');
            if(viewName === 'planning') { plan.classList.remove('hidden'); market.classList.add('hidden'); } 
            else { plan.classList.add('hidden'); market.classList.remove('hidden'); refreshMarketWidgets(); renderWatchlist(); }
        }

        // --- CALENDRIER & HUD ---
        function renderCal(){
            const c=document.getElementById('calendar'); c.innerHTML='';
            for(let i=1;i<=30;i++){
                const d=document.createElement('div'); d.className = i===todayNum ? "day day-today" : "day"; d.innerText=i;
                c.appendChild(d);
            }
            document.getElementById('hudDate').innerText=`${todayNum} ${monthNames[now.getMonth()]}`;
        }
        
        function renderHUD() {
            const timeline = document.getElementById('masterTimeline');
            timeline.innerHTML = "";
            const tasks = db[todayNum] || [];
            
            // On trie par heure
            tasks.sort((a,b) => parseInt(a.time) - parseInt(b.time));

            tasks.forEach((t, i) => {
                let accent = 'accent-task'; let dot = 'dot-task';
                
                // Style spÃ©cial pour l'alerte marchÃ©
                if(t.isMarket) { accent = 'accent-important'; dot = 'dot-important'; }

                const html = `
                <div class="timeline-row">
                    <div class="timeline-time">${t.time}</div>
                    <div class="timeline-line"></div>
                    <div class="timeline-dot ${dot}"></div>
                    <div class="flex-1 flow-card ${accent}">
                        <p class="font-bold text-lg leading-tight mb-1">${t.shortText}</p>
                        <p class="text-[10px] text-zinc-400 font-mono">${t.fullText}</p>
                    </div>
                </div>`;
                timeline.innerHTML += html;
            });
            
            if(tasks.length === 0) timeline.innerHTML = "<p class='text-center opacity-30 mt-10'>Aucune tÃ¢che planifiÃ©e.</p>";
        }

        function save(){ localStorage.setItem('lifeos_v70_db',JSON.stringify(db)); }

        // INIT
        renderCal();
        renderHUD();
        renderWatchlist();
        syncGoogleAgenda(); // LANCE LA SYNCHRO AVEC TON URL
    </script>
</body>
</html>
