<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeOS V76 - Chronos Aethelgard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: { 
                        glass: "rgba(255, 255, 255, 0.05)",
                        glassBorder: "rgba(255, 255, 255, 0.08)",
                        accent: "#3b82f6"
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #09090b; color: #e4e4e7; overflow-x: hidden; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* GLASSMORPHISM PRO */
        .bento-card {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1.5rem;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), border-color 0.2s;
        }
        .bento-card:hover { border-color: rgba(255, 255, 255, 0.15); }

        /* TIMELINE CONNECTORS */
        .timeline-line { position: absolute; left: 24px; top: 3rem; bottom: -1rem; width: 2px; background: linear-gradient(to bottom, #27272a, transparent); z-index: 0; }
        
        /* INPUT AREA */
        .input-glow:focus-within { box-shadow: 0 0 40px -10px rgba(59, 130, 246, 0.3); border-color: rgba(59, 130, 246, 0.5); }
        
        /* CALENDAR */
        .cal-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .cal-day:hover { background: rgba(255,255,255,0.05); }
        .cal-day.active { background: #fff; color: #000; box-shadow: 0 0 20px rgba(255,255,255,0.2); transform: scale(1.05); }
        .cal-dot { width: 4px; height: 4px; border-radius: 50%; margin-top: 4px; }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col lg:flex-row p-4 gap-4 max-w-[1800px] mx-auto">

    <aside class="w-full lg:w-80 flex flex-col gap-4 shrink-0">
        <div class="bento-card p-6 flex justify-between items-center">
            <div>
                <h1 class="font-bold text-xl tracking-tight">Life<span class="text-blue-500">OS</span></h1>
                <p class="text-[10px] text-zinc-500 font-mono">V76 CHRONOS</p>
            </div>
            <button onclick="toggleSettings()" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-zinc-400 transition">‚öôÔ∏è</button>
        </div>

        <div class="bento-card p-6 flex-1 min-h-[300px]">
            <div class="flex justify-between items-center mb-6">
                <span class="text-xs font-bold uppercase text-zinc-500 tracking-wider">Planning</span>
                <span id="monthLabel" class="text-sm font-semibold">...</span>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-sm font-medium text-zinc-400">
                </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="bento-card p-5 relative overflow-hidden group cursor-pointer" onclick="addWater()">
                <div class="absolute inset-0 bg-blue-500/10 scale-y-0 group-hover:scale-y-100 transition-transform origin-bottom duration-500"></div>
                <p class="text-[10px] font-bold uppercase text-blue-400 mb-1">Hydratation</p>
                <p id="waterVal" class="text-2xl font-bold text-white">0.0L</p>
                <div class="w-full bg-zinc-800 h-1 mt-3 rounded-full overflow-hidden"><div id="waterBar" class="h-full bg-blue-500 w-0 transition-all"></div></div>
            </div>
            <div class="bento-card p-5">
                <p class="text-[10px] font-bold uppercase text-green-400 mb-1">Calories</p>
                <p id="calVal" class="text-2xl font-bold text-white">--</p>
                <p class="text-[10px] text-zinc-600">Objectif dynamique</p>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col gap-4 h-[calc(100vh-2rem)]">
        
        <div class="bento-card p-1 relative group shrink-0">
            <div class="absolute inset-0 rounded-2xl bg-gradient-to-r from-blue-500/20 to-purple-500/20 opacity-0 group-focus-within:opacity-100 transition duration-500 pointer-events-none"></div>
            <div class="relative bg-[#09090b] rounded-[1.3rem] flex items-center p-2 border border-white/5 input-glow transition-all">
                <textarea id="aiInput" rows="1" class="w-full bg-transparent text-sm p-4 outline-none resize-none text-white placeholder-zinc-600 font-medium" placeholder="Parlez √† l'Architecte... (Ex: 'Match dans 3 jours √† 20h, et pr√©pare ma nutrition pour la semaine')"></textarea>
                <button onclick="runChronos()" id="sendBtn" class="h-10 px-6 rounded-xl bg-white text-black font-bold text-xs uppercase hover:bg-zinc-200 transition shrink-0 flex items-center gap-2">
                    <span>Ex√©cuter</span>
                    <span id="loader" class="hidden animate-spin">‚ü≥</span>
                </button>
            </div>
        </div>

        <div class="flex-1 flex flex-col lg:flex-row gap-4 overflow-hidden">
            
            <div class="flex-1 bento-card p-8 overflow-y-auto relative">
                <div class="absolute top-0 right-0 w-64 h-64 bg-blue-600/5 rounded-full blur-3xl pointer-events-none"></div>

                <div class="relative z-10 mb-8">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span id="currentDateTitle" class="text-xs font-mono text-zinc-400 uppercase tracking-widest">AUJOURD'HUI</span>
                    </div>
                    <h2 id="strategyTitle" class="text-3xl md:text-4xl font-bold text-white mb-2">En attente...</h2>
                    <p id="strategyText" class="text-zinc-500 text-sm leading-relaxed max-w-2xl">L'IA n'a pas encore d√©fini de strat√©gie pour cette date.</p>
                    
                    <div id="supplementsBox" class="hidden mt-4 inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-white/10 bg-white/5">
                        <span class="text-xs">üíä</span>
                        <span id="supplementsText" class="text-xs font-mono text-zinc-300">--</span>
                    </div>
                </div>

                <div id="timeline" class="space-y-0 relative pl-2">
                    </div>
            </div>

            <div class="w-full lg:w-72 hidden lg:flex flex-col gap-4">
                <div class="bento-card p-6 flex-1 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] bg-opacity-5">
                    <h3 class="text-xs font-bold uppercase text-zinc-500 mb-4">Statistiques</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between text-sm"><span class="text-zinc-400">Charge Travail</span><span class="text-white font-mono">Mod√©r√©e</span></div>
                        <div class="flex justify-between text-sm"><span class="text-zinc-400">Intensit√© Sport</span><span class="text-white font-mono">√âlev√©e</span></div>
                        <div class="w-full h-px bg-white/10 my-2"></div>
                        <p class="text-xs text-zinc-500 leading-relaxed italic">"La r√©gularit√© bat l'intensit√©. Concentrez-vous sur le sommeil ce soir."</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bento-card w-full max-w-md p-8 relative">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-zinc-500 hover:text-white">‚úï</button>
            <h2 class="text-xl font-bold mb-6">Configuration Syst√®me</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold uppercase text-blue-400">Cl√© API OpenRouter</label>
                    <input type="password" id="apiKey" class="w-full bg-black/30 border border-white/10 rounded-lg p-3 mt-1 text-sm focus:border-blue-500 outline-none text-white" placeholder="sk-or-v1-...">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] uppercase text-zinc-500">Poids (kg)</label><input id="weight" type="number" class="w-full bg-black/30 border border-white/10 rounded-lg p-3 mt-1 text-sm text-center text-white"></div>
                    <div><label class="text-[10px] uppercase text-zinc-500">Taille (cm)</label><input id="height" type="number" class="w-full bg-black/30 border border-white/10 rounded-lg p-3 mt-1 text-sm text-center text-white"></div>
                </div>
                <button onclick="saveProfile()" class="w-full py-3 bg-white text-black font-bold rounded-lg text-xs uppercase tracking-widest hover:bg-zinc-200 transition">Sauvegarder</button>
            </div>
        </div>
    </div>

    <script>
        // --- CHRONOS CORE ENGINE ---

        // State
        let store = {
            db: JSON.parse(localStorage.getItem('chronos_db') || "{}"),
            profile: JSON.parse(localStorage.getItem('chronos_profile') || '{"weight":80,"height":180,"apiKey":""}'),
            water: 0
        };
        let selectedDateStr = new Date().toISOString().split('T')[0];

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            renderCalendar();
            renderView(selectedDateStr);
            updateHydration(0);
            
            // Auto-resize textarea
            const tx = document.getElementById('aiInput');
            tx.addEventListener("input", function(){this.style.height = "auto";this.style.height = (this.scrollHeight) + "px";});
            tx.addEventListener("keypress", (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); runChronos(); }});
        });

        // --- THE BRAIN (MULTI-DAY LOGIC) ---
        async function runChronos() {
            const prompt = document.getElementById('aiInput').value;
            if(!prompt.trim()) return;
            
            if(!store.profile.apiKey) { alert("Cl√© API manquante (‚öôÔ∏è)"); return; }

            toggleLoader(true);
            const todayISO = new Date().toISOString().split('T')[0]; // ANCRE TEMPORELLE
            const dayName = new Date().toLocaleDateString('fr-FR', {weekday:'long'});

            const systemPrompt = `
                Tu es CHRONOS, une IA de planification temporelle. 
                Nous sommes le : ${dayName} ${todayISO}.
                
                TA MISSION :
                1. Analyse l'input de l'utilisateur. Il peut mentionner des √©v√©nements futurs (ex: "dans 3 jours", "mardi prochain").
                2. Calcule les dates exactes (YYYY-MM-DD) pour chaque √©v√©nement.
                3. G√©n√®re une structure JSON multi-jours.
                4. Pour chaque jour modifi√©, calcule le TDEE (Calories) selon l'activit√© et invente une strat√©gie.
                5. Sois cr√©atif sur les titres et descriptions (repas gastronomiques sains, routines pr√©cises).

                FORMAT DE REPONSE ATTENDU (JSON PUR):
                {
                    "schedule": {
                        "YYYY-MM-DD": {
                            "strategy": "Titre court de la strat√©gie du jour",
                            "summary": "Phrase explicative...",
                            "tdee": 2500,
                            "supplements": "Cr√©atine, Zinc...",
                            "events": [
                                { "time": "08:00", "title": "...", "desc": "...", "type": "sport|work|meal|social", "duration": 60 }
                            ]
                        },
                        "YYYY-MM-DD": { ... } (Si l'utilisateur parle d'autres jours)
                    }
                }
            `;

            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${store.profile.apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "openai/gpt-4o-mini",
                        messages: [{role: "system", content: systemPrompt}, {role: "user", content: prompt}]
                    })
                });

                const json = await res.json();
                let clean = json.choices[0].message.content.replace(/```json|```/g, '').trim();
                const data = JSON.parse(clean);

                // UPDATE DATABASE (MERGE INTELLIGENT)
                Object.keys(data.schedule).forEach(dateKey => {
                    store.db[dateKey] = data.schedule[dateKey];
                });

                save();
                
                // Si l'IA a modifi√© une date future, on change la vue vers cette date si c'est la seule
                const modifiedKeys = Object.keys(data.schedule);
                if(modifiedKeys.length === 1 && modifiedKeys[0] !== selectedDateStr) {
                    selectedDateStr = modifiedKeys[0];
                }

                renderCalendar();
                renderView(selectedDateStr);
                document.getElementById('aiInput').value = '';

            } catch (e) {
                alert("Erreur Chronos: " + e.message);
                console.error(e);
            } finally {
                toggleLoader(false);
            }
        }

        // --- RENDERERS ---
        function renderView(dateKey) {
            // Header Infos
            const d = new Date(dateKey);
            document.getElementById('currentDateTitle').innerText = d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' }).toUpperCase();
            
            const dayData = store.db[dateKey];

            if(!dayData) {
                document.getElementById('strategyTitle').innerText = "Journ√©e Vierge";
                document.getElementById('strategyText').innerText = "Aucune donn√©e planifi√©e pour cette date.";
                document.getElementById('supplementsBox').classList.add('hidden');
                document.getElementById('calVal').innerText = "--";
                document.getElementById('timeline').innerHTML = `<div class="p-8 text-center border border-dashed border-white/10 rounded-2xl text-zinc-600 italic">L'Architecte attend vos instructions...</div>`;
                return;
            }

            // Populate Data
            document.getElementById('strategyTitle').innerText = dayData.strategy || "Optimisation";
            document.getElementById('strategyText').innerText = dayData.summary || "";
            document.getElementById('calVal').innerText = (dayData.tdee || 2000) + " kcal";
            
            if(dayData.supplements) {
                document.getElementById('supplementsBox').classList.remove('hidden');
                document.getElementById('supplementsText').innerText = dayData.supplements;
            }

            // Timeline Generation
            let html = '';
            const events = (dayData.events || []).sort((a,b) => a.time.localeCompare(b.time));
            
            events.forEach((evt, idx) => {
                let colorClass = "bg-zinc-500";
                let icon = "‚Ä¢";
                if(evt.type === 'sport') { colorClass = "bg-orange-500 shadow-[0_0_15px_rgba(249,115,22,0.4)]"; icon = "‚ö°"; }
                if(evt.type === 'work') { colorClass = "bg-purple-500 shadow-[0_0_15px_rgba(168,85,247,0.4)]"; icon = "üß†"; }
                if(evt.type === 'meal') { colorClass = "bg-green-500 shadow-[0_0_15px_rgba(34,197,94,0.4)]"; icon = "ü•ó"; }

                html += `
                <div class="relative pl-8 py-4 group animate-slide-up" style="animation-delay: ${idx * 0.05}s">
                    <div class="timeline-line"></div>
                    <div class="absolute left-[20px] top-6 w-3 h-3 rounded-full border-2 border-[#18181b] z-10 ${colorClass}"></div>
                    
                    <div class="bento-card p-4 hover:bg-white/5 transition border-l-2 border-l-transparent hover:border-l-blue-500 cursor-default">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-mono text-sm font-bold text-blue-400">${evt.time}</span>
                            <span class="text-[10px] uppercase tracking-wider text-zinc-500 border border-white/5 px-1.5 rounded">${evt.type}</span>
                        </div>
                        <h4 class="font-bold text-white text-lg">${evt.title}</h4>
                        <p class="text-sm text-zinc-400 leading-snug mt-1">${evt.desc}</p>
                    </div>
                </div>`;
            });
            document.getElementById('timeline').innerHTML = html;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // Simple 2-week view centered on today or selection
            const baseDate = new Date();
            document.getElementById('monthLabel').innerText = baseDate.toLocaleDateString('fr-FR', {month:'long', year:'numeric'});

            // Get start of week
            const startOfWeek = new Date(baseDate);
            startOfWeek.setDate(baseDate.getDate() - baseDate.getDay() + 1); // Monday

            const days = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
            days.forEach(d => grid.innerHTML += `<div class="text-center text-[10px] text-zinc-600 py-2">${d}</div>`);

            for(let i=0; i<14; i++) { // 2 weeks
                const d = new Date(startOfWeek);
                d.setDate(startOfWeek.getDate() + i);
                const iso = d.toISOString().split('T')[0];
                const hasData = store.db[iso];
                const isSelected = iso === selectedDateStr;
                const isToday = iso === new Date().toISOString().split('T')[0];

                let classes = "cal-day py-2";
                if(isSelected) classes += " active";
                else if(isToday) classes += " border border-blue-500/50 text-blue-400";
                else classes += " text-zinc-400";

                grid.innerHTML += `
                <div class="${classes}" onclick="selectDate('${iso}')">
                    <span>${d.getDate()}</span>
                    ${hasData ? `<div class="cal-dot ${isSelected ? 'bg-black' : 'bg-blue-500'}"></div>` : ''}
                </div>`;
            }
        }

        // --- UTILS ---
        function selectDate(iso) { selectedDateStr = iso; renderCalendar(); renderView(iso); }
        function addWater() { store.water += 0.25; updateHydration(store.water); }
        function updateHydration(val) {
            document.getElementById('waterVal').innerText = val.toFixed(1) + "L";
            document.getElementById('waterBar').style.width = Math.min((val/2.5)*100, 100) + "%";
        }
        function saveProfile() {
            store.profile.apiKey = document.getElementById('apiKey').value;
            store.profile.weight = document.getElementById('weight').value;
            store.profile.height = document.getElementById('height').value;
            localStorage.setItem('chronos_profile', JSON.stringify(store.profile));
            toggleSettings();
        }
        function save() { localStorage.setItem('chronos_db', JSON.stringify(store.db)); }
        function toggleSettings() { 
            const m = document.getElementById('modal'); 
            m.classList.toggle('hidden');
            if(!m.classList.contains('hidden')) {
                document.getElementById('apiKey').value = store.profile.apiKey || '';
                document.getElementById('weight').value = store.profile.weight;
                document.getElementById('height').value = store.profile.height;
            }
        }
        function toggleLoader(show) {
            const btn = document.getElementById('sendBtn');
            const loader = document.getElementById('loader');
            if(show) { btn.disabled = true; loader.classList.remove('hidden'); }
            else { btn.disabled = false; loader.classList.add('hidden'); }
        }

    </script>
</body>
</html>
