<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeOS Sovereign V73 - Elite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #050505; background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%); color: #fff; -webkit-font-smoothing: antialiased; min-height: 100vh; }
        .glass-base { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(40px); border: 1px solid rgba(255, 255, 255, 0.05); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border-radius: 1.5rem; }
        
        .flow-card { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.03); border-radius: 1.25rem; transition: all 0.3s ease; position: relative; overflow: hidden; padding: 1.25rem; cursor: pointer; }
        .flow-card:hover { transform: translateX(5px); background: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1); }
        
        .timeline-row { display: flex; gap: 1.5rem; position: relative; padding-bottom: 2rem; }
        .timeline-time { width: 50px; text-align: right; font-family: monospace; font-size: 0.85rem; font-weight: 700; opacity: 0.6; padding-top: 1.25rem; }
        .timeline-line { position: absolute; left: 63px; top: 20px; bottom: -20px; width: 2px; background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(255,255,255,0.02)); }
        .timeline-dot { position: absolute; left: 58px; top: 25px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #000; box-shadow: 0 0 15px rgba(255,255,255,0.3); z-index: 10; }
        
        /* Context Styles */
        .ctx-sport { border-left: 3px solid #f97316; } 
        .ctx-focus { border-left: 3px solid #8b5cf6; }
        .ctx-meal { border-left: 3px solid #10b981; }
        .ctx-task { border-left: 3px solid #3b82f6; }
        
        .badge { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; padding: 2px 8px; border-radius: 6px; letter-spacing: 0.05em; }
        .badge-vit { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; border: 1px solid rgba(16, 185, 129, 0.3); }
        
        .primary-btn { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); transition: 0.3s; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); }
        .ai-loading { animation: thinking 1.5s infinite; background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); }
        @keyframes thinking { 0% { border-color: #3b82f6; } 50% { border-color: #8b5cf6; } 100% { border-color: #3b82f6; } }

        .nav-active { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: white; }
        .nav-btn { color: #9ca3af; } .nav-btn:hover { color: white; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-[1700px] mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <aside class="lg:col-span-3 flex flex-col gap-6 h-[calc(100vh-4rem)] sticky top-8">
            <div class="glass-base p-6 space-y-6 flex-1 flex flex-col">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold tracking-tight">Life<span class="text-blue-500 italic">OS</span> <span class="text-[10px] bg-white/10 text-zinc-300 px-2 py-0.5 rounded ml-2">V73</span></h1>
                    <button onclick="openProfile()" class="text-[10px] font-bold bg-white/10 px-3 py-1.5 rounded-full hover:bg-white/20">‚öôÔ∏è</button>
                </div>

                <div class="grid grid-cols-2 gap-2 bg-black/20 p-1 rounded-2xl">
                    <button onclick="switchView('planning')" id="nav-planning" class="nav-btn nav-active py-2 rounded-xl text-xs font-bold transition-all">üìÖ Planning</button>
                    <button onclick="switchView('market')" id="nav-market" class="nav-btn py-2 rounded-xl text-xs font-bold transition-all">üìà Bourse</button>
                </div>

                <div><p class="text-[9px] font-bold uppercase tracking-widest text-zinc-500 mb-2">Calendrier</p><div id="calendar" class="grid grid-cols-7 gap-1"></div></div>
                
                <div class="flex-1">
                    <p class="text-[9px] font-bold uppercase tracking-widest text-zinc-500 mb-2">Claude 3.5 Intelligence</p>
                    <textarea id="userInput" class="w-full bg-black/20 border border-white/5 rounded-2xl p-4 text-sm outline-none resize-none focus:border-blue-500/50 transition-colors h-32" placeholder="Ex: 'Crossfit √† 18h et R√©union projet √† 14h'"></textarea>
                    <button id="aiBtn" onclick="traiterBatchIA()" class="primary-btn w-full mt-3 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest flex justify-center gap-2"><span>‚ú®</span> Planifier</button>
                </div>
            </div>
        </aside>

        <main class="lg:col-span-9 space-y-6 pb-10">
            
            <div id="view-planning" class="glass-base p-8 md:p-10 transition-colors duration-500">
                <div class="flex flex-col md:flex-row justify-between md:items-end mb-8 gap-6">
                    <div>
                        <div class="flex items-center gap-2 mb-2"><span id="dayIndicator" class="w-2 h-2 rounded-full bg-blue-500"></span><span class="text-[10px] font-bold uppercase tracking-widest opacity-60">Op√©rations</span></div>
                        <h2 id="hudDate" class="text-4xl md:text-5xl font-black tracking-tight text-white">Date</h2>
                        <div id="contextBanner" class="mt-4 inline-flex items-center gap-3 bg-white/5 px-4 py-2 rounded-xl border border-white/5"><span id="ctxIcon" class="text-2xl">‚öñÔ∏è</span><div><p class="text-sm font-bold text-white" id="contextTitle">Standard</p><p class="text-[10px] opacity-50 uppercase tracking-widest" id="contextSubtitle">Mode Activ√©</p></div></div>
                    </div>
                    <div class="flex gap-6">
                        <div class="bg-black/20 p-4 rounded-2xl border border-white/5 text-right w-32">
                            <p class="text-[9px] font-bold uppercase text-zinc-500 mb-1">Cible Calories</p>
                            <p id="calTarget" class="text-xl font-mono font-medium text-white">--</p>
                        </div>
                        <div class="bg-black/20 p-4 rounded-2xl border border-white/5 text-right w-32">
                            <p class="text-[9px] font-bold uppercase text-zinc-500 mb-1">Suppl√©ments</p>
                            <p id="hudSupplements" class="text-xs font-bold text-green-400 leading-tight">--</p>
                        </div>
                    </div>
                </div>

                <div class="relative pl-4 pt-4 border-t border-white/5">
                    <p class="text-xs font-bold uppercase opacity-30 mb-8 tracking-widest pl-12 mt-6">Timeline</p>
                    <div id="masterTimeline"></div>
                </div>
            </div>

            <div id="view-market" class="hidden space-y-6">
                <div class="tradingview-widget-container">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
                    { "symbols": [{"proName":"FOREXCOM:SPXUSD","title":"S&P 500"},{"proName":"FX_IDC:EURUSD","title":"EUR/USD"},{"proName":"BITSTAMP:BTCUSD","title":"Bitcoin"},{"proName":"TVC:CAC40","title":"CAC 40"},{"proName":"TVC:GOLD","title":"Or"}], "showSymbolLogo": true, "colorTheme": "dark", "isTransparent": true, "displayMode": "adaptive", "locale": "fr" }
                    </script>
                </div>

                <div class="glass-base h-[500px] overflow-hidden p-1 border border-white/10">
                    <div class="tradingview-widget-container" style="height:100%;width:100%">
                        <div id="tradingview_advanced" style="height:100%;width:100%"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-base p-6">
                        <div class="flex items-center gap-3 mb-4"><span class="text-xl">üß≠</span><h3 class="font-bold">Recommandation Technique</h3></div>
                        <div class="tradingview-widget-container" style="height: 200px">
                            <div class="tradingview-widget-container__widget"></div>
                            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js" async>
                            { "interval": "1D", "width": "100%", "isTransparent": true, "height": "100%", "symbol": "TVC:CAC40", "showIntervalTabs": true, "displayMode": "single", "locale": "fr", "colorTheme": "dark" }
                            </script>
                        </div>
                    </div>
                    <div class="glass-base p-6">
                        <div class="flex items-center gap-3 mb-4"><span class="text-xl">üöÄ</span><h3 class="font-bold">Crypto Trend</h3></div>
                        <div class="tradingview-widget-container" style="height: 200px">
                             <div class="tradingview-widget-container__widget"></div>
                             <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
                             { "symbol": "BINANCE:BTCUSDT", "width": "100%", "height": "100%", "locale": "fr", "dateRange": "12M", "colorTheme": "dark", "isTransparent": true, "autosize": true, "largeChartUrl": "" }
                             </script>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="profileModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-md">
        <div class="glass-base p-8 max-w-sm w-full rounded-[2rem] text-center">
            <h2 class="text-xl font-bold mb-6">Syst√®me & Cl√© API</h2>
            <div class="space-y-3 mb-6">
                <input type="password" id="inputApiKey" class="w-full bg-black/20 p-4 rounded-xl text-center text-white outline-none border border-blue-500/30 focus:border-blue-500" placeholder="Cl√© OpenRouter (sk-or-...)">
                <input type="number" id="inputWeight" class="w-full bg-black/20 p-4 rounded-xl text-center text-white outline-none" placeholder="Poids (kg)">
            </div>
            <button onclick="saveProfile()" class="primary-btn w-full py-4 rounded-xl font-bold uppercase text-xs">Sauvegarder</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION & DONN√âES ---
        let db = JSON.parse(localStorage.getItem('lifeos_v73_db') || "{}");
        let profile = JSON.parse(localStorage.getItem('lifeos_profile') || '{"weight":80}');
        let apiKey = localStorage.getItem('lifeos_apikey') || ""; 
        const now = new Date(); const todayNum = now.getDate(); let selectedDay = todayNum;
        const monthNames = ["Jan", "F√©v", "Mar", "Avr", "Mai", "Juin", "Juil", "Ao√ªt", "Sep", "Oct", "Nov", "D√©c"];

        // BASE DE DONN√âES BIO-MOTEUR (Repas & Vitamines)
        const BIO_DB = {
            sport: {
                title: "Haute Performance", icon: "üî•", color: "text-orange-500",
                lunch: ["P√¢tes Compl√®tes Poulet", "Riz Basmati Boeuf 5%", "Gnocchis Dinde", "Bowl Quinoa Saumon"],
                dinner: ["Omelette PDT", "Cabillaud Riz", "Wrap Poulet Avocat", "Saucisse Lentilles"],
                supps: "Magn√©sium, Cr√©atine, BCAA",
                desc: "Riche en glucides & prot√©ines"
            },
            focus: {
                title: "Deep Work", icon: "üß†", color: "text-purple-500",
                lunch: ["Salade C√©sar Poulet", "Saumon Haricots Verts", "Bowl Tofu", "Carpaccio Boeuf"],
                dinner: ["Wok L√©gumes", "Soupe Maison", "Poisson Papillote", "Salade Grecque"],
                supps: "Omega-3, Vitamine D, Matcha",
                desc: "Low Carb, High Fat (Cognition)"
            },
            chill: {
                title: "R√©cup√©ration", icon: "üåø", color: "text-green-500",
                lunch: ["Taboul√© Libanais", "Quiche L√©gumes", "Sandwich Dinde", "Poke Bowl"],
                dinner: ["Velout√© Potiron", "Oeufs Brouill√©s", "Avocado Toast", "Yaourt Fruits"],
                supps: "Multivitamines, Probiotiques",
                desc: "√âquilibre & Digestion"
            }
        };

        // --- 2. LOGIQUE IA (CLAUDE 3.5 SONNET) ---
        async function traiterBatchIA() {
            const raw = document.getElementById('userInput').value;
            if (!raw.trim() || !apiKey) { if(!apiKey) openProfile(); return; }
            const btn = document.getElementById('aiBtn'); const oldTxt = btn.innerHTML;
            btn.innerHTML = "<span>üß†</span> Analyse..."; btn.disabled = true;

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST", headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json", "HTTP-Referer": window.location.href, "X-Title": "LifeOS V73" },
                    body: JSON.stringify({
                        "model": "anthropic/claude-3.5-sonnet",
                        "messages": [
                            { "role": "system", "content": `Tu es LifeOS. Aujourd'hui: ${new Date().toLocaleDateString()}. Retourne un JSON strict des t√¢ches. Si sport d√©tect√©, titre="Sport". Si r√©union/travail, titre="Travail". Format: [{"shortText":"Titre","fullText":"Origine","time":"HH:MM","duration":60,"dayOffset":0}]` },
                            { "role": "user", "content": raw }
                        ]
                    })
                });
                const data = await response.json();
                const tasks = JSON.parse(data.choices[0].message.content.replace(/```json|```/g, '').trim());
                
                tasks.forEach(t => {
                    const targetDate = new Date(); targetDate.setDate(now.getDate() + (t.dayOffset||0)); const d = targetDate.getDate();
                    if (!db[d]) db[d] = [];
                    db[d].push({ shortText: t.shortText, fullText: t.fullText, time: t.time, duration: t.duration, done: false });
                });
                save(); renderHUD();
                document.getElementById('userInput').value = '';
            } catch (e) { alert("Erreur IA: " + e.message); } 
            finally { btn.innerHTML = oldTxt; btn.disabled = false; }
        }

        // --- 3. MOTEUR D'AFFICHAGE & BIO-LOGIQUE ---
        function renderHUD() {
            // Setup Date & Status
            document.getElementById('hudDate').innerText = `${selectedDay} ${monthNames[now.getMonth()]}`;
            
            // 1. D√©tection du Contexte (Mode)
            const tasks = db[selectedDay] || [];
            let mode = 'chill';
            tasks.forEach(t => {
                const txt = (t.fullText + t.shortText).toLowerCase();
                if(txt.match(/sport|gym|muscu|crossfit|foot|run/)) mode = 'sport';
                else if(txt.match(/r√©union|bureau|travail|projet|code/) && mode !== 'sport') mode = 'focus';
            });
            const theme = BIO_DB[mode];

            // UI Updates based on Mode
            document.getElementById('contextTitle').innerText = theme.title;
            document.getElementById('contextTitle').className = `text-sm font-bold ${theme.color}`;
            document.getElementById('contextSubtitle').innerText = theme.desc;
            document.getElementById('ctxIcon').innerText = theme.icon;
            document.getElementById('hudSupplements').innerText = theme.supps;
            document.getElementById('calTarget').innerText = (mode === 'sport' ? Math.round(profile.weight * 32) : Math.round(profile.weight * 26)) + " kcal";

            // 2. Construction Timeline (Flux)
            let stream = [];
            const rot = (selectedDay - 1) % 4; // Rotation des repas
            
            // Repas Midi (Auto-inject√© selon contexte)
            stream.push({ 
                type: 'meal', time: '12:30', 
                name: theme.lunch[rot], 
                desc: mode === 'sport' ? "Chargement Glycog√®ne" : "L√©ger & Nutritif",
                vit: theme.supps.split(',')[0] // Affiche la 1ere vitamine
            });

            // Repas Soir (Auto-inject√©)
            stream.push({ 
                type: 'meal', time: '20:00', 
                name: theme.dinner[rot], 
                desc: "Reconstruction & Sommeil",
                vit: "Hydratation"
            });

            // T√¢ches Utilisateur
            tasks.forEach((t, i) => {
                let style = "ctx-task";
                if((t.fullText||"").match(/sport|gym/i)) style = "ctx-sport";
                else if((t.fullText||"").match(/travail|r√©union/i)) style = "ctx-focus";
                
                stream.push({ 
                    type: 'task', time: t.time, 
                    name: t.shortText, desc: t.fullText, 
                    style: style, id: i, done: t.done 
                });
            });

            // Tri Chronologique
            stream.sort((a,b) => parseInt(a.time.replace(':','')) - parseInt(b.time.replace(':','')));

            // Rendu HTML
            document.getElementById('masterTimeline').innerHTML = stream.map(item => {
                let content = '';
                if(item.type === 'meal') {
                    content = `<div class="flex justify-between items-center"><div class="flex flex-col"><div class="flex items-center gap-2 mb-1"><span class="badge badge-vit">${item.vit}</span></div><span class="font-bold text-lg">${item.name}</span><span class="text-xs opacity-50">${item.desc}</span></div><div class="text-2xl opacity-20">üçΩÔ∏è</div></div>`;
                } else {
                    content = `<div class="flex items-center gap-4 group cursor-pointer" onclick="toggleTask(${selectedDay},${item.id})"><div class="w-5 h-5 rounded border border-white/20 flex items-center justify-center ${item.done?'bg-white text-black':''}">${item.done?'‚úì':''}</div><div class="${item.done?'line-through opacity-30':''}"><p class="font-bold text-lg">${item.name}</p><p class="text-xs opacity-50 truncate w-64">${item.desc}</p></div><button onclick="event.stopPropagation();delTask(${selectedDay},${item.id})" class="ml-auto text-red-500 opacity-0 group-hover:opacity-100 text-xs">SUPPR</button></div>`;
                }
                
                let borderClass = item.type === 'meal' ? 'ctx-meal' : item.style;
                if(item.done) borderClass = "border-l-2 border-white/20";

                return `<div class="timeline-row"><div class="timeline-time">${item.time}</div><div class="timeline-line"></div><div class="timeline-dot bg-black border border-white"></div><div class="flex-1 flow-card ${borderClass} ${item.done?'opacity-50':''}">${content}</div></div>`;
            }).join('');
        }

        // --- 4. NAVIGATION & UTILITAIRES ---
        let tvInit = false;
        function switchView(v) {
            document.getElementById('view-planning').classList.add('hidden');
            document.getElementById('view-market').classList.add('hidden');
            document.getElementById('nav-planning').classList.remove('nav-active');
            document.getElementById('nav-market').classList.remove('nav-active');
            
            document.getElementById('view-'+v).classList.remove('hidden');
            document.getElementById('nav-'+v).classList.add('nav-active');

            if(v === 'market' && !tvInit) {
                new TradingView.widget({ "autosize": true, "symbol": "TVC:CAC40", "interval": "D", "timezone": "Europe/Paris", "theme": "dark", "style": "1", "locale": "fr", "enable_publishing": false, "container_id": "tradingview_advanced" });
                tvInit = true;
            }
        }

        // Sauvegardes & Helpers
        function save(){localStorage.setItem('lifeos_v73_db',JSON.stringify(db)); localStorage.setItem('lifeos_apikey',apiKey); renderCal(); renderHUD(); }
        function toggleTask(d,i){db[d][i].done=!db[d][i].done;save();}
        function delTask(d,i){db[d].splice(i,1);save();}
        function openProfile(){document.getElementById('profileModal').classList.remove('hidden'); document.getElementById('inputApiKey').value = apiKey; }
        function saveProfile(){apiKey=document.getElementById('inputApiKey').value; profile.weight=document.getElementById('inputWeight').value||80; localStorage.setItem('lifeos_profile',JSON.stringify(profile)); document.getElementById('profileModal').classList.add('hidden'); save();}
        function renderCal(){const c=document.getElementById('calendar');c.innerHTML='';const m=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();for(let i=1;i<=m;i++){const d=document.createElement('div');let cls="day";if(i===todayNum)cls+=" day-today";if(i===selectedDay)cls+=" day-selected";if(db[i]&&db[i].length)cls+=" has-event";d.className=cls;d.innerText=i;d.onclick=()=>{selectedDay=i;renderHUD();renderCal();};c.appendChild(d);}}

        renderCal(); renderHUD();
    </script>
</body>
</html>
