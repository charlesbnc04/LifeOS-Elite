<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeOS V77 - Flux Quantum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'pulse-slow': 'pulse 3s infinite'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #050505; color: #e4e4e7; overflow-x: hidden; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }

        /* BENTO GLASS CARD */
        .bento-card {
            background: rgba(20, 20, 23, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1.2rem;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.2), 0 10px 30px -10px rgba(0,0,0,0.5);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .bento-card:hover { border-color: rgba(255, 255, 255, 0.1); transform: translateY(-1px); }

        /* TIMELINE */
        .timeline-line { position: absolute; left: 23px; top: 3.5rem; bottom: -1rem; width: 1px; background: linear-gradient(to bottom, #3f3f46 0%, transparent 100%); z-index: 0; }
        
        /* INPUT AREA */
        .input-area { background: #0a0a0a; border: 1px solid rgba(255,255,255,0.08); transition: all 0.3s; }
        .input-area:focus-within { border-color: #3b82f6; box-shadow: 0 0 30px -10px rgba(59, 130, 246, 0.3); }
        
        /* CALENDAR */
        .cal-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; cursor: pointer; transition: all 0.2s; font-size: 0.8rem; }
        .cal-day:hover { background: rgba(255,255,255,0.08); }
        .cal-day.active { background: #fff; color: #000; font-weight: 800; box-shadow: 0 0 20px rgba(255,255,255,0.2); transform: scale(1.1); z-index: 10; }
        .cal-dot { width: 3px; height: 3px; border-radius: 50%; margin-top: 3px; }

        /* TAGS */
        .tag-sport { background: rgba(249, 115, 22, 0.1); color: #fb923c; border: 1px solid rgba(249, 115, 22, 0.2); }
        .tag-work { background: rgba(168, 85, 247, 0.1); color: #c084fc; border: 1px solid rgba(168, 85, 247, 0.2); }
        .tag-meal { background: rgba(34, 197, 94, 0.1); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.2); }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col lg:flex-row p-4 gap-4 max-w-[1920px] mx-auto font-sans">

    <aside class="w-full lg:w-80 flex flex-col gap-4 shrink-0 h-fit lg:h-[calc(100vh-2rem)] sticky top-4">
        <div class="bento-card p-5 flex justify-between items-center">
            <div>
                <h1 class="font-bold text-lg tracking-tight text-white">Life<span class="text-blue-500 italic">OS</span></h1>
                <p class="text-[9px] text-zinc-500 font-mono tracking-widest">V77 FLUX QUANTUM</p>
            </div>
            <button onclick="toggleSettings()" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-zinc-400 transition">⚙️</button>
        </div>

        <div class="bento-card p-5 flex-1 min-h-[320px] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <span class="text-[10px] font-bold uppercase text-zinc-500 tracking-wider">Navigation</span>
                <span id="monthLabel" class="text-xs font-bold text-white">...</span>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 gap-2 text-xs font-medium text-zinc-500 flex-1 content-start">
                </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <div class="bento-card p-4 cursor-pointer group relative overflow-hidden" onclick="addWater()">
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-blue-500/20"><div id="waterBar" class="h-full bg-blue-500 w-0 transition-all duration-500"></div></div>
                <p class="text-[9px] font-bold uppercase text-blue-400 mb-1">Eau</p>
                <p id="waterVal" class="text-xl font-bold text-white group-hover:scale-105 transition">0L</p>
            </div>
            <div class="bento-card p-4">
                <p class="text-[9px] font-bold uppercase text-green-400 mb-1">Cible</p>
                <p id="calVal" class="text-xl font-bold text-white">--</p>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col gap-4 h-[calc(100vh-2rem)]">
        
        <div class="shrink-0 relative group">
            <div class="input-area rounded-2xl flex items-center p-2 pr-3">
                <textarea id="aiInput" rows="1" class="w-full bg-transparent text-sm p-4 outline-none resize-none text-white placeholder-zinc-600 font-medium" placeholder="Ex: 'Dissertation le 3 Janvier, répartis le travail sur la semaine avant.'"></textarea>
                <button onclick="runQuantumFlux()" id="sendBtn" class="h-10 px-5 rounded-xl bg-white hover:bg-blue-50 text-black font-bold text-[10px] uppercase tracking-wider transition shrink-0 flex items-center gap-2 shadow-[0_0_20px_rgba(255,255,255,0.3)]">
                    <span>Optimiser</span>
                    <span id="loader" class="hidden animate-spin">⟳</span>
                </button>
            </div>
        </div>

        <div class="flex-1 flex flex-col lg:flex-row gap-4 overflow-hidden">
            
            <div class="flex-1 bento-card p-8 overflow-y-auto relative custom-scroll">
                <div class="mb-10 sticky top-0 bg-[#141417]/80 backdrop-blur-xl z-20 -mx-8 px-8 py-4 border-b border-white/5 flex justify-between items-end">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-pulse-slow"></div>
                            <span id="currentDateTitle" class="text-[10px] font-mono text-blue-400 uppercase tracking-widest">AUJOURD'HUI</span>
                        </div>
                        <h2 id="strategyTitle" class="text-2xl font-bold text-white">Focus</h2>
                    </div>
                    <div id="supplementsBox" class="hidden text-right">
                        <p class="text-[9px] uppercase text-zinc-500 font-bold mb-1">Protocole</p>
                        <p id="supplementsText" class="text-xs font-mono text-zinc-300">--</p>
                    </div>
                </div>

                <div id="emptyState" class="hidden h-64 flex flex-col items-center justify-center text-zinc-600">
                    <span class="text-4xl mb-4 opacity-20">⌬</span>
                    <p class="text-sm italic">"Le temps est une ressource, pas une contrainte."</p>
                </div>

                <div id="timeline" class="space-y-2 relative pl-2 pb-10">
                    </div>
            </div>

            <div class="w-full lg:w-72 hidden lg:flex flex-col gap-4">
                <div class="bento-card p-6 flex-1 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] bg-opacity-5 flex flex-col justify-end">
                    <h3 class="text-xs font-bold uppercase text-zinc-500 mb-4">Stratégie IA</h3>
                    <p id="strategyText" class="text-sm text-zinc-300 leading-relaxed italic border-l-2 border-blue-500/50 pl-3">
                        En attente de directives pour structurer la réalité.
                    </p>
                </div>
            </div>

        </div>
    </main>

    <div id="modal" class="hidden fixed inset-0 z-50 bg-black/90 backdrop-blur-xl flex items-center justify-center p-4">
        <div class="bento-card w-full max-w-md p-8 relative">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-zinc-500 hover:text-white">✕</button>
            <h2 class="text-lg font-bold mb-6">Paramètres Système</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold uppercase text-blue-400">Clé API OpenRouter</label>
                    <input type="password" id="apiKey" class="w-full bg-black/30 border border-white/10 rounded-lg p-3 mt-1 text-xs font-mono focus:border-blue-500 outline-none text-white placeholder-zinc-700" placeholder="sk-or-v1-...">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] uppercase text-zinc-500">Poids (kg)</label><input id="weight" type="number" class="w-full bg-black/30 border border-white/10 rounded-lg p-3 mt-1 text-sm text-center text-white"></div>
                    <div><label class="text-[10px] uppercase text-zinc-500">Taille (cm)</label><input id="height" type="number" class="w-full bg-black/30 border border-white/10 rounded-lg p-3 mt-1 text-sm text-center text-white"></div>
                </div>
                <button onclick="saveProfile()" class="w-full py-3 bg-white text-black font-bold rounded-lg text-xs uppercase tracking-widest hover:bg-zinc-200 transition">Sauvegarder</button>
            </div>
        </div>
    </div>

    <script>
        // --- QUANTUM CORE ---

        // State Management
        let store = {
            db: JSON.parse(localStorage.getItem('lifeos_v77_db') || "{}"),
            profile: JSON.parse(localStorage.getItem('lifeos_v77_profile') || '{"weight":75,"height":180,"apiKey":""}'),
            water: 0
        };
        let selectedDateStr = new Date().toISOString().split('T')[0];

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderCalendar();
            renderView(selectedDateStr);
            
            // Auto-resize & Shortcuts
            const tx = document.getElementById('aiInput');
            tx.addEventListener("input", function(){this.style.height = "auto";this.style.height = (this.scrollHeight) + "px";});
            tx.addEventListener("keypress", (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); runQuantumFlux(); }});
        });

        // --- THE BRAIN (SMART OVERWRITE) ---
        async function runQuantumFlux() {
            const prompt = document.getElementById('aiInput').value;
            if(!prompt.trim()) return;
            if(!store.profile.apiKey) { alert("⚠️ Configurez votre Clé API (Engrenage)"); return; }

            toggleLoader(true);
            const todayISO = new Date().toISOString().split('T')[0];
            const dayName = new Date().toLocaleDateString('fr-FR', {weekday:'long'});

            // CRUCIAL: On envoie un "Snapshot" des données existantes à l'IA pour qu'elle sache quoi modifier/effacer.
            // On envoie seulement les clés (dates) qui ont des données pour ne pas saturer le prompt.
            const existingDates = Object.keys(store.db).filter(k => k >= todayISO).slice(0, 10); // Prochains 10 jours actifs
            const contextSummary = existingDates.map(d => `${d}: ${store.db[d].strategy}`).join(', ');

            const systemPrompt = `
                Tu es LIFE OS V77. Date actuelle : ${dayName} ${todayISO}.
                
                PRIME DIRECTIVE (RÈGLE ABSOLUE) :
                Si l'utilisateur demande de REPLANIFIER, DÉPLACER ou RÉPARTIR une tâche (ex: "Répartis le travail du 3 janv sur la semaine"),
                tu DOIS renvoyer le JSON pour TOUS les jours impactés, Y COMPRIS le jour d'origine pour le vider ou le modifier.
                
                Exemple: Si l'utilisateur dit "Enlève le travail de demain", renvoie un JSON pour demain avec une liste d'événements vide ou allégée.
                NE FAIS PAS QUE "AJOUTER". TU DOIS "RÉÉCRIRE" LES JOURS CONCERNÉS.

                Format JSON attendu :
                {
                    "schedule": {
                        "YYYY-MM-DD": {
                            "strategy": "Titre Court",
                            "summary": "Explication de tes choix...",
                            "tdee": 2400,
                            "supplements": "Caféine, Omega-3",
                            "events": [
                                { "time": "09:00", "title": "...", "desc": "...", "type": "work|sport|meal|other", "duration": 60 }
                            ]
                        }
                    }
                }
                Si un jour doit être vidé, renvoie "events": [] pour ce jour-là.
            `;

            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${store.profile.apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "openai/gpt-4o-mini",
                        messages: [
                            {role: "system", content: systemPrompt}, 
                            {role: "user", content: `Ma demande : "${prompt}".\nContexte actuel (dates occupées): ${contextSummary}`}
                        ]
                    })
                });

                const json = await res.json();
                let clean = json.choices[0].message.content.replace(/```json|```/g, '').trim();
                const data = JSON.parse(clean);

                // UPDATE DESTRUCTIF INTELLIGENT
                // On écrase complètement les jours renvoyés par l'IA.
                Object.keys(data.schedule).forEach(dateKey => {
                    store.db[dateKey] = data.schedule[dateKey];
                });

                save();
                
                // Si l'IA a modifié le jour qu'on regarde, on refresh, sinon on saute au premier jour modifié
                const modifiedKeys = Object.keys(data.schedule).sort();
                if(!modifiedKeys.includes(selectedDateStr) && modifiedKeys.length > 0) {
                    selectedDateStr = modifiedKeys[0];
                }

                renderCalendar();
                renderView(selectedDateStr);
                document.getElementById('aiInput').value = '';

            } catch (e) {
                alert("Erreur Flux: " + e.message);
                console.error(e);
            } finally {
                toggleLoader(false);
            }
        }

        // --- RENDERERS ---
        function renderView(dateKey) {
            const d = new Date(dateKey);
            document.getElementById('currentDateTitle').innerText = d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' }).toUpperCase();
            
            const dayData = store.db[dateKey];
            const timeline = document.getElementById('timeline');
            
            if(!dayData || !dayData.events || dayData.events.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                timeline.innerHTML = '';
                document.getElementById('strategyTitle').innerText = "Libre";
                document.getElementById('strategyText').innerText = "Aucune planification pour cette date.";
                document.getElementById('supplementsBox').classList.add('hidden');
                document.getElementById('calVal').innerText = "--";
                return;
            }

            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('strategyTitle').innerText = dayData.strategy || "Optimisation";
            document.getElementById('strategyText').innerText = dayData.summary || "";
            document.getElementById('calVal').innerText = (dayData.tdee || 2000) + " kcal";
            
            if(dayData.supplements) {
                document.getElementById('supplementsBox').classList.remove('hidden');
                document.getElementById('supplementsText').innerText = dayData.supplements;
            } else {
                document.getElementById('supplementsBox').classList.add('hidden');
            }

            let html = '';
            const events = dayData.events.sort((a,b) => a.time.localeCompare(b.time));
            
            events.forEach((evt, idx) => {
                let tagClass = "text-zinc-400 border-zinc-700 bg-zinc-800/50";
                if(evt.type === 'sport') tagClass = "tag-sport";
                if(evt.type === 'work') tagClass = "tag-work";
                if(evt.type === 'meal') tagClass = "tag-meal";

                html += `
                <div class="relative pl-8 py-3 animate-slide-up group" style="animation-delay: ${idx * 0.05}s">
                    <div class="timeline-line"></div>
                    <div class="absolute left-[20px] top-5 w-2 h-2 rounded-full border border-[#18181b] z-10 bg-white group-hover:scale-125 transition"></div>
                    
                    <div class="bento-card p-4 hover:bg-white/[0.02] transition cursor-default flex flex-col gap-2">
                        <div class="flex justify-between items-start">
                            <span class="font-mono text-sm font-bold text-white">${evt.time}</span>
                            <span class="text-[10px] uppercase font-bold tracking-wider px-2 py-0.5 rounded-md border ${tagClass}">${evt.type}</span>
                        </div>
                        <div>
                            <h4 class="font-bold text-zinc-100 text-base leading-tight">${evt.title}</h4>
                            <p class="text-xs text-zinc-500 mt-1 leading-relaxed">${evt.desc}</p>
                        </div>
                    </div>
                </div>`;
            });
            timeline.innerHTML = html;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            const baseDate = new Date();
            document.getElementById('monthLabel').innerText = baseDate.toLocaleDateString('fr-FR', {month:'long'}).toUpperCase();

            // Headers Jours
            ['L','M','M','J','V','S','D'].forEach(d => grid.innerHTML += `<div class="text-center py-2 opacity-30">${d}</div>`);

            // 2 Weeks View
            const startOfWeek = new Date(baseDate);
            startOfWeek.setDate(baseDate.getDate() - (baseDate.getDay() === 0 ? 6 : baseDate.getDay() - 1));

            for(let i=0; i<14; i++) {
                const d = new Date(startOfWeek);
                d.setDate(startOfWeek.getDate() + i);
                const iso = d.toISOString().split('T')[0];
                const hasData = store.db[iso] && store.db[iso].events && store.db[iso].events.length > 0;
                const isSelected = iso === selectedDateStr;
                const isToday = iso === new Date().toISOString().split('T')[0];

                let classes = "cal-day py-2 relative";
                if(isSelected) classes += " active";
                else if(isToday) classes += " text-blue-400 border border-blue-500/30";
                else classes += " text-zinc-500";

                grid.innerHTML += `
                <div class="${classes}" onclick="selectDate('${iso}')">
                    <span>${d.getDate()}</span>
                    ${hasData ? `<div class="cal-dot ${isSelected ? 'bg-black' : 'bg-blue-500'}"></div>` : ''}
                </div>`;
            }
        }

        // --- UTILS ---
        function selectDate(iso) { selectedDateStr = iso; renderCalendar(); renderView(iso); }
        function addWater() { store.water += 0.25; updateHydration(store.water); }
        function updateHydration(val) {
            document.getElementById('waterVal').innerText = val.toFixed(1) + "L";
            document.getElementById('waterBar').style.width = Math.min((val/2.5)*100, 100) + "%";
        }
        function saveProfile() {
            store.profile.apiKey = document.getElementById('apiKey').value;
            store.profile.weight = document.getElementById('weight').value;
            store.profile.height = document.getElementById('height').value;
            localStorage.setItem('lifeos_v77_profile', JSON.stringify(store.profile));
            toggleSettings();
        }
        function save() { localStorage.setItem('lifeos_v77_db', JSON.stringify(store.db)); }
        function toggleSettings() { 
            document.getElementById('modal').classList.toggle('hidden');
            document.getElementById('apiKey').value = store.profile.apiKey || '';
            document.getElementById('weight').value = store.profile.weight;
            document.getElementById('height').value = store.profile.height;
        }
        function toggleLoader(show) {
            const btn = document.getElementById('sendBtn');
            const loader = document.getElementById('loader');
            if(show) { btn.disabled = true; loader.classList.remove('hidden'); }
            else { btn.disabled = false; loader.classList.add('hidden'); }
        }

    </script>
</body>
</html>
