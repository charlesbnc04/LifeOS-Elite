<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeOS V75 - Quantum Graph</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #09090b; color: #fff; height: 100vh; overflow: hidden; }
        
        /* GLASS UI */
        .glass-panel { background: #18181b; border-right: 1px solid #27272a; }
        .glass-main { background: #09090b; }
        
        /* TIME GRID SYSTEM */
        .day-grid-container { 
            position: relative; 
            height: 100%; 
            overflow-y: auto; 
            background: radial-gradient(circle at 50% 50%, #18181b 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Lignes horaires */
        .grid-hour-row { 
            height: 80px; /* 1 heure = 80px */
            border-bottom: 1px solid #27272a; 
            position: relative;
        }
        .grid-hour-label { 
            position: absolute; 
            left: 10px; 
            top: -10px; 
            font-size: 11px; 
            color: #71717a; 
            background: #09090b; 
            padding-right: 5px;
        }

        /* BLOCS ÉVÉNEMENTS */
        .event-block {
            position: absolute;
            left: 60px; 
            right: 20px;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 13px;
            border-left: 4px solid;
            transition: all 0.2s ease;
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }
        .event-block:hover { transform: scale(1.01); z-index: 20; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        
        /* CATEGORIES COLORS */
        .cat-client { background: rgba(59, 130, 246, 0.15); border-color: #3b82f6; color: #bfdbfe; } /* Bleu */
        .cat-sport { background: rgba(249, 115, 22, 0.15); border-color: #f97316; color: #fdba74; } /* Orange */
        .cat-work { background: rgba(139, 92, 246, 0.15); border-color: #8b5cf6; color: #ddd6fe; } /* Violet */
        .cat-health { background: rgba(16, 185, 129, 0.15); border-color: #10b981; color: #6ee7b7; } /* Vert */
        .cat-social { background: rgba(236, 72, 153, 0.15); border-color: #ec4899; color: #fbcfe8; } /* Rose */

        /* CURRENT TIME LINE */
        .current-time-line { position: absolute; left: 0; right: 0; border-top: 2px solid #ef4444; z-index: 50; pointer-events: none; }
        .current-time-dot { position: absolute; left: 55px; top: -5px; width: 10px; height: 10px; background: #ef4444; border-radius: 50%; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        
        .ai-loading { animation: pulse 1.5s infinite; opacity: 0.7; pointer-events: none; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="flex overflow-hidden">

    <aside class="w-[350px] glass-panel flex flex-col h-full z-20 shadow-2xl">
        <div class="p-6 border-b border-white/5">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-xl font-bold tracking-tight">Life<span class="text-blue-500">OS</span> <span class="text-[10px] text-zinc-500">V75</span></h1>
                <button onclick="openProfile()" class="text-xs bg-white/5 hover:bg-white/10 px-3 py-1 rounded transition">⚙️</button>
            </div>
            
            <div id="calendar" class="grid grid-cols-7 gap-1 mb-6 text-xs font-mono"></div>

            <div class="flex gap-2 bg-black/40 p-1 rounded-lg">
                <button onclick="switchView('planning')" id="btn-plan" class="flex-1 py-2 text-xs font-bold bg-white/10 rounded text-white">PLANNING</button>
                <button onclick="switchView('market')" id="btn-market" class="flex-1 py-2 text-xs font-bold text-zinc-500 hover:text-white">BOURSE</button>
            </div>
        </div>

        <div class="flex-1 p-6 overflow-y-auto">
            <label class="text-[10px] font-bold text-blue-500 uppercase tracking-widest mb-2 block">Instruction IA</label>
            <textarea id="userInput" class="w-full bg-black/40 border border-white/10 rounded-xl p-3 text-sm outline-none focus:border-blue-500 h-24 resize-none mb-3 text-zinc-300 placeholder-zinc-600" placeholder="Ex: 'Client Apple de 9h à 12h, puis Sport 1h30'"></textarea>
            <button id="aiBtn" onclick="runAI()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl text-xs uppercase tracking-wider transition-all shadow-[0_0_20px_rgba(37,99,235,0.3)]">Générer le Graphique</button>
            
            <div class="mt-8">
                <p class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-4">Répartition</p>
                <div id="statsContainer" class="space-y-3">
                    <p class="text-xs text-zinc-600 italic">En attente de données...</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 glass-main relative h-full flex flex-col">
        
        <div class="h-16 border-b border-white/5 flex items-center justify-between px-8 bg-[#09090b] z-10">
            <div>
                <h2 id="currentDateDisplay" class="text-lg font-bold">Aujourd'hui</h2>
                <p class="text-xs text-zinc-500" id="currentDateSub">Planning Graphique</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p class="text-[10px] uppercase text-zinc-500 font-bold">Calories</p>
                    <p id="calDisplay" class="text-sm font-mono font-bold text-green-400">--</p>
                </div>
            </div>
        </div>

        <div id="view-planning" class="flex-1 relative overflow-hidden">
            <div class="day-grid-container" id="dayGrid">
                </div>
            <div id="nowLine" class="current-time-line hidden"><div class="current-time-dot"></div></div>
        </div>

        <div id="view-market" class="hidden flex-1 flex flex-col">
            <div class="h-[60px]">
                <div class="tradingview-widget-container">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
                    { "symbols": [{"proName":"FOREXCOM:SPXUSD","title":"S&P 500"},{"proName":"FX_IDC:EURUSD","title":"EUR/USD"},{"proName":"BITSTAMP:BTCUSD","title":"Bitcoin"},{"proName":"TVC:CAC40","title":"CAC 40"}], "colorTheme": "dark", "isTransparent": true, "displayMode": "adaptive", "locale": "fr" }
                    </script>
                </div>
            </div>
            <div class="flex-1 p-1">
                <div class="tradingview-widget-container" style="height:100%;width:100%">
                    <div id="tv_chart_container" style="height:100%;width:100%"></div>
                </div>
            </div>
        </div>

    </main>

    <div id="profileModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-[#18181b] border border-white/10 p-8 rounded-2xl w-96 shadow-2xl">
            <h3 class="text-lg font-bold mb-4">Configuration</h3>
            <input type="password" id="apiKeyInput" class="w-full bg-black/50 border border-white/10 p-3 rounded-lg text-sm mb-4 outline-none focus:border-blue-500" placeholder="Clé API OpenRouter">
            <input type="number" id="weightInput" class="w-full bg-black/50 border border-white/10 p-3 rounded-lg text-sm mb-4 outline-none" placeholder="Poids (kg)">
            <button onclick="saveProfile()" class="w-full bg-white text-black font-bold py-3 rounded-lg text-sm hover:bg-zinc-200">Sauvegarder</button>
        </div>
    </div>

    <script>
        // CONFIGURATION
        let db = JSON.parse(localStorage.getItem('lifeos_v75_db') || "{}");
        let config = JSON.parse(localStorage.getItem('lifeos_config') || '{"apiKey":"", "weight":80}');
        const START_HOUR = 6; // Le graphique commence à 6h
        const END_HOUR = 23;  // Finit à 23h
        const TOTAL_MINUTES = (END_HOUR - START_HOUR) * 60;
        
        let selectedDay = new Date().getDate();
        const now = new Date();

        // INIT
        function init() {
            renderCalendar();
            renderDayGrid();
            updateStats();
            updateNowLine();
            setInterval(updateNowLine, 60000); // Mise à jour ligne rouge chaque minute
            
            // Calcul calories base
            document.getElementById('calDisplay').innerText = Math.round(config.weight * 28) + " kcal";
        }

        // --- MOTEUR GRAPHIQUE (Le cœur du système) ---
        function renderDayGrid() {
            const container = document.getElementById('dayGrid');
            container.innerHTML = ''; // Reset

            // 1. Dessiner la grille de fond (Lignes horaires)
            for (let h = START_HOUR; h <= END_HOUR; h++) {
                const row = document.createElement('div');
                row.className = 'grid-hour-row';
                row.innerHTML = `<span class="grid-hour-label">${h}:00</span>`;
                container.appendChild(row);
            }

            // 2. Récupérer les tâches du jour
            const tasks = db[selectedDay] || [];

            // 3. Dessiner les blocs (Positionnement Absolu)
            tasks.forEach(task => {
                const [hStart, mStart] = task.time.split(':').map(Number);
                const startInMinutes = (hStart * 60) + mStart;
                const offsetMinutes = startInMinutes - (START_HOUR * 60); // Minutes depuis 6h du mat

                // Si hors limite, on ignore (ou on adapte)
                if (offsetMinutes < 0) return; 

                // Calcul position et hauteur
                // 1 heure = 80px (défini dans CSS .grid-hour-row)
                const PIXELS_PER_MINUTE = 80 / 60; 
                
                const topPos = offsetMinutes * PIXELS_PER_MINUTE;
                const height = task.duration * PIXELS_PER_MINUTE;

                // Création élément
                const el = document.createElement('div');
                
                // Détermination classe couleur
                let colorClass = 'cat-work'; // Défaut
                if (task.category === 'client') colorClass = 'cat-client';
                if (task.category === 'sport') colorClass = 'cat-sport';
                if (task.category === 'health') colorClass = 'cat-health';
                if (task.category === 'social') colorClass = 'cat-social';

                el.className = `event-block ${colorClass}`;
                el.style.top = `${topPos}px`;
                el.style.height = `${Math.max(30, height)}px`; // Min 30px pour lisibilité

                el.innerHTML = `
                    <div class="font-bold leading-tight">${task.shortText}</div>
                    <div class="text-[10px] opacity-70 mt-1 truncate">${task.time} - ${addMinutes(task.time, task.duration)}</div>
                `;
                
                // Suppression au clic droit
                el.oncontextmenu = (e) => { e.preventDefault(); if(confirm('Supprimer ?')) { delTask(selectedDay, task); } };
                
                container.appendChild(el);
            });
        }

        function updateNowLine() {
            const d = new Date();
            const currentMin = (d.getHours() * 60) + d.getMinutes();
            const offset = currentMin - (START_HOUR * 60);
            const line = document.getElementById('nowLine');
            
            if (offset > 0 && offset < TOTAL_MINUTES && selectedDay === d.getDate()) {
                line.classList.remove('hidden');
                line.style.top = `${offset * (80/60)}px`;
            } else {
                line.classList.add('hidden');
            }
        }

        // --- INTELLIGENCE ARTIFICIELLE (OpenRouter) ---
        async function runAI() {
            const prompt = document.getElementById('userInput').value;
            if (!prompt) return;
            if (!config.apiKey) { openProfile(); return; }

            const btn = document.getElementById('aiBtn');
            const originalTxt = btn.innerText;
            btn.innerText = "CALCUL DES COORDONNÉES...";
            btn.classList.add('ai-loading');

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${config.apiKey}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href,
                        "X-Title": "LifeOS V75"
                    },
                    body: JSON.stringify({
                        "model": "anthropic/claude-3.5-sonnet",
                        "messages": [
                            {
                                "role": "system",
                                "content": `Tu es un Planificateur Graphique.
                                Analyse l'entrée. Retourne un JSON strict.
                                CATEGORIES DISPONIBLES : 'client', 'sport', 'work', 'health', 'social'.
                                Si l'utilisateur mentionne un nom de client ou "dossier", category='client'.
                                Règle : duration en minutes. time format HH:MM. dayOffset (0=ajd).
                                Exemple : [{"shortText":"Dossier Apple","time":"09:00","duration":120,"category":"client","dayOffset":0}]`
                            },
                            { "role": "user", "content": prompt }
                        ]
                    })
                });

                const data = await response.json();
                const tasks = JSON.parse(data.choices[0].message.content.replace(/```json|```/g, '').trim());

                tasks.forEach(t => {
                    const targetD = new Date(); 
                    targetD.setDate(new Date().getDate() + (t.dayOffset || 0));
                    const d = targetD.getDate();
                    
                    if (!db[d]) db[d] = [];
                    db[d].push(t);
                });

                saveDB();
                renderDayGrid();
                updateStats();
                document.getElementById('userInput').value = '';

            } catch (e) {
                alert("Erreur IA : " + e.message);
            } finally {
                btn.innerText = originalTxt;
                btn.classList.remove('ai-loading');
            }
        }

        // --- HELPERS & STATS ---
        function updateStats() {
            const tasks = db[selectedDay] || [];
            if(tasks.length === 0) { document.getElementById('statsContainer').innerHTML = '<p class="text-xs text-zinc-600">Aucune donnée.</p>'; return; }

            let stats = { client: 0, sport: 0, work: 0 };
            tasks.forEach(t => {
                if(stats[t.category] !== undefined) stats[t.category] += t.duration;
                else stats.work += t.duration; // Default
            });

            // Conversion en barres
            const total = Object.values(stats).reduce((a,b)=>a+b,0) || 1;
            
            let html = '';
            if(stats.client > 0) html += makeStatBar('Clients', stats.client, total, 'bg-blue-500');
            if(stats.work > 0) html += makeStatBar('Deep Work', stats.work, total, 'bg-purple-500');
            if(stats.sport > 0) html += makeStatBar('Sport', stats.sport, total, 'bg-orange-500');

            document.getElementById('statsContainer').innerHTML = html;
        }

        function makeStatBar(label, min, total, colorBg) {
            const pct = (min / total) * 100;
            const h = Math.floor(min/60); const m = min%60;
            return `
            <div>
                <div class="flex justify-between text-[10px] mb-1"><span>${label}</span><span>${h}h${m>0?m:''}</span></div>
                <div class="h-1.5 w-full bg-white/10 rounded-full overflow-hidden"><div class="h-full ${colorBg}" style="width:${pct}%"></div></div>
            </div>`;
        }

        function renderCalendar() {
            const c = document.getElementById('calendar'); c.innerHTML = '';
            const today = new Date().getDate();
            const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth()+1, 0).getDate();
            
            for(let i=1; i<=daysInMonth; i++) {
                const d = document.createElement('div');
                let cls = "text-center py-1 cursor-pointer rounded hover:bg-white/10 transition ";
                if(i === today) cls += "text-blue-500 font-bold ";
                if(i === selectedDay) cls += "bg-white/20 text-white font-bold ";
                else cls += "text-zinc-500 ";
                
                d.className = cls;
                d.innerText = i;
                d.onclick = () => { selectedDay = i; document.getElementById('currentDateDisplay').innerText = `Le ${i}`; renderCalendar(); renderDayGrid(); updateStats(); };
                c.appendChild(d);
            }
            document.getElementById('currentDateDisplay').innerText = selectedDay === today ? "Aujourd'hui" : `Le ${selectedDay}`;
        }

        function addMinutes(time, mins) {
            const [h, m] = time.split(':').map(Number);
            const date = new Date(); date.setHours(h, m + mins);
            return `${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
        }

        // NAVIGATION & MODALS
        function switchView(v) {
            document.getElementById('view-planning').classList.add('hidden');
            document.getElementById('view-market').classList.add('hidden');
            document.getElementById('btn-plan').className = "flex-1 py-2 text-xs font-bold text-zinc-500 hover:text-white";
            document.getElementById('btn-market').className = "flex-1 py-2 text-xs font-bold text-zinc-500 hover:text-white";

            if(v === 'planning') {
                document.getElementById('view-planning').classList.remove('hidden');
                document.getElementById('btn-plan').className = "flex-1 py-2 text-xs font-bold bg-white/10 rounded text-white";
            } else {
                document.getElementById('view-market').classList.remove('hidden');
                document.getElementById('btn-market').className = "flex-1 py-2 text-xs font-bold bg-white/10 rounded text-white";
                // Init chart only once
                if(!window.tvChartInit) {
                    new TradingView.widget({ "autosize": true, "symbol": "TVC:CAC40", "interval": "D", "timezone": "Europe/Paris", "theme": "dark", "style": "1", "locale": "fr", "enable_publishing": false, "container_id": "tv_chart_container" });
                    window.tvChartInit = true;
                }
            }
        }

        function openProfile() { document.getElementById('profileModal').classList.remove('hidden'); document.getElementById('apiKeyInput').value = config.apiKey; document.getElementById('weightInput').value = config.weight; }
        function saveProfile() {
            config.apiKey = document.getElementById('apiKeyInput').value;
            config.weight = document.getElementById('weightInput').value;
            localStorage.setItem('lifeos_config', JSON.stringify(config));
            document.getElementById('profileModal').classList.add('hidden');
            init();
        }
        function saveDB() { localStorage.setItem('lifeos_v75_db', JSON.stringify(db)); }
        function delTask(d, tRef) { db[d] = db[d].filter(t => t !== tRef); saveDB(); renderDayGrid(); updateStats(); }

        // Start
        init();
    </script>
</body>
</html>
