<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>LifeOS V90 - Neural Link</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --card: #0f0f11; --accent: #3b82f6; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: #e5e5e5; min-height: 100vh; padding-bottom: 100px; }
        .glass { background: rgba(20,20,20,0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.05); }
        .loader { width: 20px; height: 20px; border: 2px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Markdown simulation for timeline */
        .timeline-line { position: absolute; left: 19px; top: 30px; bottom: -20px; width: 2px; background: #222; z-index: 0; }
    </style>
</head>
<body class="max-w-4xl mx-auto p-4 md:p-6">

    <header class="flex justify-between items-center mb-8 sticky top-2 z-50 glass p-4 rounded-xl">
        <div class="flex items-center gap-3">
            <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]" id="connectionStatus"></div>
            <h1 class="font-bold tracking-tight">LifeOS <span class="text-blue-500">V90</span></h1>
        </div>
        <button onclick="UI.openSettings()" class="text-xs font-mono opacity-50 hover:opacity-100">API_KEY_CONFIG</button>
    </header>

    <section class="mb-8">
        <div class="bg-[#0f0f11] border border-white/5 rounded-2xl p-1 relative group focus-within:border-blue-500/50 transition-colors">
            <textarea id="promptInput" 
                class="w-full bg-transparent p-4 h-24 outline-none resize-none font-mono text-sm placeholder-white/20" 
                placeholder="Ex: 'Planifie 3 s√©ances de sport cette semaine √† 18h', 'R√©union demain matin √† 10h'..."></textarea>
            
            <div class="flex justify-between items-center px-4 pb-2">
                <div class="text-[10px] text-gray-500 font-mono">MODEL: GPT-4o / CLAUDE 3.5</div>
                <button onclick="LLM.send()" id="sendBtn" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-2">
                    <span>EXECUTE</span>
                </button>
            </div>
        </div>
        <p id="aiFeedback" class="text-xs text-center mt-2 text-blue-400 font-mono h-4"></p>
    </section>

    <div id="calendarStrip" class="flex gap-2 overflow-x-auto pb-4 mb-4 no-scrollbar"></div>

    <main id="timeline" class="space-y-4 min-h-[400px]">
        <div class="text-center opacity-20 py-20 font-mono text-sm">NO DATA STREAM</div>
    </main>

    <div id="settingsModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur z-[100] flex items-center justify-center">
        <div class="bg-[#111] p-6 rounded-2xl border border-white/10 w-full max-w-md">
            <h2 class="text-lg font-bold mb-4">OpenRouter Configuration</h2>
            <p class="text-xs text-gray-400 mb-2">Entrez votre cl√© API OpenRouter (sk-or-...). Elle est stock√©e localement.</p>
            <input type="password" id="apiKeyInput" class="w-full bg-black border border-white/20 p-3 rounded-lg text-sm mb-4 outline-none focus:border-blue-500" placeholder="sk-or-v1-...">
            
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('settingsModal').classList.add('hidden')" class="px-4 py-2 text-xs text-gray-400">Annuler</button>
                <button onclick="UI.saveKey()" class="px-4 py-2 bg-blue-600 rounded-lg text-xs font-bold">Sauvegarder</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CORE DATA & STATE ---
        const DB = {
            tasks: JSON.parse(localStorage.getItem('lifeos_v90_tasks') || '{}'), // Format: { "YYYY-MM-DD": [Tasks] }
            key: localStorage.getItem('lifeos_v90_apikey') || '',
            selectedDate: new Date().toISOString().split('T')[0],
            
            save() {
                localStorage.setItem('lifeos_v90_tasks', JSON.stringify(this.tasks));
                UI.render();
            }
        };

        // --- 2. OPENROUTER API CLIENT ---
        const LLM = {
            async send() {
                const input = document.getElementById('promptInput');
                const btn = document.getElementById('sendBtn');
                const text = input.value.trim();
                
                if (!text) return;
                if (!DB.key) { UI.openSettings(); return; }

                // UI Loading State
                btn.innerHTML = '<span class="loader"></span> PROCESSING';
                btn.disabled = true;
                document.getElementById('aiFeedback').innerText = "Connecting to Neural Network...";

                const today = new Date();
                const dayName = today.toLocaleDateString('fr-FR', { weekday: 'long' });
                const dateStr = today.toISOString().split('T')[0];

                // SYSTEM PROMPT: LE COEUR DE L'INTELLIGENCE
                // On force l'IA √† agir comme un API JSON strict.
                const systemPrompt = `
                Tu es LifeOS, une IA de planification temporelle d'√©lite.
                Nous sommes le : ${dayName} ${dateStr}.
                
                TA MISSION : Analyser la demande de l'utilisateur et retourner un tableau JSON strict d'√©v√©nements.
                
                R√àGLES CRITIQUES :
                1. Comprends les dates relatives : "demain" = ${dateStr} + 1 jour, "lundi prochain" = date calcul√©e.
                2. Si l'utilisateur ne pr√©cise pas de date, assume AUJOURD'HUI (${dateStr}).
                3. Si l'utilisateur ne pr√©cise pas d'heure, d√©duis une heure logique selon le contexte (Sport=18h, Travail=09h).
                4. "type" doit √™tre : 'sport', 'work', 'meal', 'other'.
                
                FORMAT DE R√âPONSE ATTENDU (JSON PUR SEULEMENT, PAS DE MARKDOWN) :
                [
                    {
                        "date": "YYYY-MM-DD",
                        "time": "HH:MM",
                        "title": "Nom de la tache",
                        "duration": 60,
                        "type": "work"
                    }
                ]
                `;

                try {
                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${DB.key}`,
                            "Content-Type": "application/json",
                            "HTTP-Referer": window.location.href, // Requis par OpenRouter
                        },
                        body: JSON.stringify({
                            "model": "openai/gpt-4o", // Tu peux changer pour "anthropic/claude-3.5-sonnet"
                            "messages": [
                                { "role": "system", "content": systemPrompt },
                                { "role": "user", "content": text }
                            ],
                            "temperature": 0.2 // Tr√®s bas pour √™tre logique et strict
                        })
                    });

                    if (!response.ok) throw new Error("API Error");

                    const data = await response.json();
                    let aiContent = data.choices[0].message.content;

                    // Nettoyage si l'IA met du markdown ```json ... ```
                    aiContent = aiContent.replace(/```json/g, '').replace(/```/g, '').trim();
                    
                    const newTasks = JSON.parse(aiContent);
                    
                    // Injection dans la DB
                    let count = 0;
                    newTasks.forEach(task => {
                        if (!DB.tasks[task.date]) DB.tasks[task.date] = [];
                        DB.tasks[task.date].push({
                            id: Date.now() + Math.random(),
                            ...task,
                            done: false
                        });
                        count++;
                    });

                    DB.save();
                    input.value = '';
                    document.getElementById('aiFeedback').innerText = `${count} √âv√©nements synchronis√©s avec succ√®s.`;
                    setTimeout(() => document.getElementById('aiFeedback').innerText = '', 3000);

                } catch (e) {
                    console.error(e);
                    document.getElementById('aiFeedback').innerText = "ERREUR : V√©rifiez votre cl√© API ou le format de r√©ponse.";
                    alert("Erreur: " + e.message + "\nL'IA n'a pas renvoy√© un JSON valide ou la cl√© est mauvaise.");
                } finally {
                    btn.innerHTML = 'EXECUTE';
                    btn.disabled = false;
                }
            }
        };

        // --- 3. UI RENDERING ---
        const UI = {
            init() {
                this.renderCalendarStrip();
                this.render();
                if(!DB.key) document.getElementById('connectionStatus').classList.replace('bg-green-500', 'bg-red-500');
            },

            openSettings() {
                document.getElementById('apiKeyInput').value = DB.key;
                document.getElementById('settingsModal').classList.remove('hidden');
            },

            saveKey() {
                const k = document.getElementById('apiKeyInput').value.trim();
                if(k.startsWith('sk-or-')) {
                    DB.key = k;
                    localStorage.setItem('lifeos_v90_apikey', k);
                    document.getElementById('settingsModal').classList.add('hidden');
                    document.getElementById('connectionStatus').classList.replace('bg-red-500', 'bg-green-500');
                    alert("Syst√®me connect√© au Neural Network.");
                } else {
                    alert("Cl√© invalide. Elle doit commencer par sk-or-...");
                }
            },

            renderCalendarStrip() {
                const strip = document.getElementById('calendarStrip');
                strip.innerHTML = '';
                const today = new Date();
                
                for(let i=0; i<14; i++) { // 14 jours de visibilit√©
                    const d = new Date();
                    d.setDate(today.getDate() + i);
                    const iso = d.toISOString().split('T')[0];
                    const dayLetter = d.toLocaleDateString('fr-FR', {weekday:'short'}).toUpperCase().slice(0,3);
                    const dayNum = d.getDate();
                    
                    const isActive = iso === DB.selectedDate;
                    const hasEvents = DB.tasks[iso] && DB.tasks[iso].length > 0;

                    const el = document.createElement('div');
                    el.className = `flex-shrink-0 w-14 h-16 rounded-xl flex flex-col items-center justify-center cursor-pointer transition border ${isActive ? 'bg-white text-black border-white' : 'bg-[#111] border-white/10 hover:border-white/30'} ${hasEvents && !isActive ? 'border-b-blue-500 border-b-2' : ''}`;
                    el.innerHTML = `<span class="text-[10px] font-bold opacity-60">${dayLetter}</span><span class="text-lg font-bold">${dayNum}</span>`;
                    el.onclick = () => { DB.selectedDate = iso; UI.renderCalendarStrip(); UI.render(); };
                    strip.appendChild(el);
                }
            },

            render() {
                const container = document.getElementById('timeline');
                const tasks = DB.tasks[DB.selectedDate] || [];
                container.innerHTML = '';

                if(tasks.length === 0) {
                    container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 opacity-30"><span class="text-4xl mb-4">üï∏Ô∏è</span><p class="font-mono text-xs">AUCUNE ACTIVIT√â D√âTECT√âE<br>POUR LE ${DB.selectedDate}</p></div>`;
                    return;
                }

                tasks.sort((a,b) => a.time.localeCompare(b.time));

                tasks.forEach((t, index) => {
                    let color = 'border-l-gray-500';
                    let icon = '‚óè';
                    if(t.type === 'sport') { color = 'border-l-orange-500'; icon = 'üî•'; }
                    if(t.type === 'work') { color = 'border-l-blue-500'; icon = 'üß†'; }
                    if(t.type === 'meal') { color = 'border-l-green-500'; icon = 'ü•ó'; }

                    const html = `
                    <div class="relative pl-8 group">
                        ${index !== tasks.length -1 ? '<div class="timeline-line"></div>' : ''}
                        <div class="absolute left-0 top-1 w-10 text-[10px] font-mono opacity-50 text-right">${t.time}</div>
                        <div class="absolute left-[16px] top-1.5 w-2 h-2 rounded-full bg-[#333] border border-white/20 z-10 group-hover:bg-white transition-colors"></div>
                        
                        <div class="glass p-4 rounded-xl border-l-4 ${color} hover:bg-white/5 transition-all cursor-pointer relative" onclick="UI.toggle(${t.id})">
                             <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-sm ${t.done ? 'line-through opacity-40' : ''}">${t.title}</h3>
                                    <p class="text-[10px] font-mono opacity-50 mt-1 uppercase">${t.duration} MIN ‚Ä¢ ${t.type}</p>
                                </div>
                                <span class="text-lg grayscale opacity-50 group-hover:grayscale-0 group-hover:opacity-100 transition">${icon}</span>
                            </div>
                            <button onclick="event.stopPropagation(); UI.delete(${t.id})" class="absolute top-2 right-2 text-[10px] text-red-500 opacity-0 group-hover:opacity-100">DEL</button>
                        </div>
                    </div>`;
                    container.insertAdjacentHTML('beforeend', html);
                });
            },

            toggle(id) {
                const list = DB.tasks[DB.selectedDate];
                const t = list.find(x => x.id === id);
                if(t) { t.done = !t.done; DB.save(); }
            },
            delete(id) {
                if(confirm('Supprimer ?')) {
                    DB.tasks[DB.selectedDate] = DB.tasks[DB.selectedDate].filter(x => x.id !== id);
                    DB.save();
                }
            }
        };

        // Init App
        UI.init();
    </script>
</body>
</html>
