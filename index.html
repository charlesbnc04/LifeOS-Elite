<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LifeOS Singularity V80</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --glass: rgba(10, 10, 10, 0.7); --border: rgba(255, 255, 255, 0.08); --accent: #3b82f6; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #000; color: #e5e5e5; min-height: 100vh; padding-bottom: 100px;
               background-image: radial-gradient(circle at 50% 0%, #1a1a2e 0%, #000 60%); }
        
        /* SYSTEME BENTO AVANCÃ‰ */
        .glass { background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid var(--border); }
        .card { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 1.25rem; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); overflow: hidden; position: relative; }
        .card:active { transform: scale(0.98); }
        
        /* LOGIC VISUALIZATION */
        .ai-pulse { animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }

        /* TIMELINE FLUIDE */
        .timeline-node { position: relative; padding-left: 3rem; padding-bottom: 2rem; border-left: 2px solid rgba(255,255,255,0.05); margin-left: 1rem; }
        .node-dot { position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: #111; border: 2px solid #555; z-index: 10; transition: all 0.3s; }
        .node-time { position: absolute; left: -60px; top: -2px; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; opacity: 0.5; width: 45px; text-align: right; }
        
        /* INPUT IA */
        .ai-input-wrapper { position: relative; overflow: hidden; border-radius: 1rem; }
        .ai-glow { position: absolute; inset: -1px; background: linear-gradient(90deg, #3b82f6, #8b5cf6, #3b82f6); background-size: 200% 100%; animation: moveGradient 3s linear infinite; opacity: 0; transition: opacity 0.3s; z-index: 0; }
        .ai-glow.active { opacity: 1; }
        @keyframes moveGradient { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }
        
        /* UTILS */
        .hidden { display: none !important; }
        input[type="range"] { -webkit-appearance: none; background: rgba(255,255,255,0.1); height: 4px; border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: white; border-radius: 50%; }
    </style>
</head>
<body class="p-4 md:p-6 max-w-[1200px] mx-auto selection:bg-blue-500/30">

    <header class="flex justify-between items-center mb-8 sticky top-4 z-50 glass p-4 rounded-2xl shadow-2xl">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center text-white font-bold text-lg shadow-lg shadow-blue-900/50">V80</div>
            <div>
                <h1 class="text-sm font-bold tracking-tight text-white leading-none">Singularity</h1>
                <div class="flex items-center gap-1 mt-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[10px] uppercase tracking-widest opacity-50 font-mono">AI ONLINE</span>
                </div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="System.wipe()" class="w-10 h-10 rounded-full bg-white/5 hover:bg-red-500/20 text-xs transition flex items-center justify-center">âš </button>
            <button onclick="UI.toggleProfile()" class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 transition flex items-center justify-center">ðŸ‘¤</button>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <aside class="space-y-6">
            <div class="card p-6 border-blue-500/30 bg-blue-900/5">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xs font-bold uppercase text-blue-400 tracking-widest mb-1">Cerveau Temporel</h2>
                        <p id="aiStatus" class="text-xl font-bold">En attente...</p>
                    </div>
                    <div class="text-2xl">ðŸ§ </div>
                </div>
                
                <div class="ai-input-wrapper bg-black/40">
                    <div id="aiGlow" class="ai-glow"></div>
                    <textarea id="neuralInput" class="relative z-10 w-full bg-transparent border-none text-sm p-4 h-24 outline-none resize-none placeholder-white/20" 
                    placeholder="Ex: 'Muscu bras 1h', 'Deep Work', 'Lire 30min'. L'IA trouvera le meilleur crÃ©neau."></textarea>
                </div>
                
                <div class="flex justify-between items-center mt-3">
                    <span id="tokenCount" class="text-[9px] font-mono opacity-30">Ready</span>
                    <button onclick="AI.processBatch()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider shadow-lg shadow-blue-600/20 transition transform hover:-translate-y-1">Optimiser</button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="card p-4 flex flex-col justify-between h-32" onclick="Data.addWater(0.25)">
                    <div class="flex justify-between"><span class="text-xl">ðŸ’§</span><span id="waterVal" class="font-mono font-bold">0.0L</span></div>
                    <div>
                        <div class="w-full bg-white/10 h-1 rounded-full overflow-hidden mb-2"><div id="waterBar" class="bg-cyan-400 h-full w-0 transition-all duration-500"></div></div>
                        <p class="text-[10px] opacity-50 uppercase">Hydratation</p>
                    </div>
                </div>
                <div class="card p-4 flex flex-col justify-between h-32">
                    <div class="flex justify-between"><span class="text-xl">âš¡</span><span id="energyScore" class="font-mono font-bold">100%</span></div>
                    <div>
                         <div class="w-full bg-white/10 h-1 rounded-full overflow-hidden mb-2"><div id="energyBar" class="bg-yellow-400 h-full w-full transition-all duration-500"></div></div>
                        <p class="text-[10px] opacity-50 uppercase">Charge Mentale</p>
                    </div>
                </div>
            </div>

            <div class="card p-5">
                <div class="flex justify-between items-end mb-4">
                    <h3 id="currentDateDisplay" class="text-lg font-bold">--</h3>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-center text-xs font-mono"></div>
            </div>
        </aside>

        <main class="lg:col-span-2 space-y-6">
            <div class="glass rounded-3xl p-6 min-h-[600px]">
                <div class="flex justify-between items-center mb-8 pl-4">
                    <h2 class="text-xs font-bold uppercase tracking-[0.2em] opacity-40">Flux de la journÃ©e</h2>
                    <div id="contextBadge" class="text-[10px] px-2 py-1 bg-white/5 rounded border border-white/10 font-mono">MODE: NEUTRE</div>
                </div>

                <div id="timelineContainer" class="space-y-0">
                    </div>
                
                <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 opacity-30">
                    <div class="text-4xl mb-2">ðŸŒ‘</div>
                    <p class="text-sm font-mono">Aucune donnÃ©e temporelle.</p>
                </div>
            </div>
        </main>
    </div>

    <div id="profileModal" class="hidden fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center">
        <div class="glass p-8 max-w-sm w-full rounded-2xl text-center space-y-4 border border-white/10">
            <h2 class="text-xl font-bold">Configuration SystÃ¨me</h2>
            <p class="text-xs opacity-50">ParamÃ©trez votre avatar physique pour le calcul mÃ©tabolique.</p>
            <input id="inputName" type="text" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl text-center outline-none focus:border-blue-500" placeholder="Nom de code">
            <div class="flex gap-2">
                <input id="inputWeight" type="number" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl text-center outline-none" placeholder="Poids (kg)">
                <input id="inputHeight" type="number" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl text-center outline-none" placeholder="Taille (cm)">
            </div>
            <button onclick="Data.saveProfile()" class="w-full bg-white text-black font-bold py-3 rounded-xl hover:scale-[1.02] transition">INITIALISER</button>
        </div>
    </div>

    <script>
        /**
         * LIFEOS V80 - ARCHITECTURE "SINGULARITY"
         * Pattern: State -> Logic -> Render
         * Cet objet global contient toute l'application.
         */
        const App = {
            state: {
                user: null, // { name, weight, height }
                date: new Date(),
                db: {}, // Structure: { "YYYY-MM-DD": [Tasks] }
                health: { water: 0, energy: 100 },
                config: {
                    morningStart: 7, // 7h00
                    nightStart: 23,  // 23h00
                }
            },

            // --- 1. CORE DATA LAYER ---
            init() {
                // Load Data
                const saved = localStorage.getItem('lifeos_v80_db');
                const user = localStorage.getItem('lifeos_v80_user');
                const health = localStorage.getItem('lifeos_v80_health');
                
                if (saved) this.state.db = JSON.parse(saved);
                if (health) this.state.health = JSON.parse(health);
                
                if (!user) {
                    UI.toggleProfile(true);
                } else {
                    this.state.user = JSON.parse(user);
                    UI.render();
                }
                
                // Clock Update
                setInterval(() => UI.updateClock(), 60000);
            },

            save() {
                localStorage.setItem('lifeos_v80_db', JSON.stringify(this.state.db));
                localStorage.setItem('lifeos_v80_user', JSON.stringify(this.state.user));
                localStorage.setItem('lifeos_v80_health', JSON.stringify(this.state.health));
                UI.render();
            }
        };

        /**
         * --- 2. ARTIFICIAL INTELLIGENCE ENGINE ---
         * Le cerveau qui comprend le temps et l'espace.
         */
        const AI = {
            // Analyse le langage naturel et extrait les intentions
            parseIntent(text) {
                const lower = text.toLowerCase();
                let duration = 60; // DÃ©faut 1h
                let time = null;
                let type = 'neutral';
                let context = 'generic';

                // DÃ©tection DurÃ©e
                const durMatch = text.match(/(\d+)\s*(min|h)/i);
                if (durMatch) {
                    duration = durMatch[2] === 'h' ? parseInt(durMatch[1]) * 60 : parseInt(durMatch[1]);
                }

                // DÃ©tection Heure (ex: 18h30)
                const timeMatch = text.match(/(\d{1,2})[h:](\d{2})?/i);
                if (timeMatch) {
                    time = parseInt(timeMatch[1]) * 60 + (timeMatch[2] ? parseInt(timeMatch[2]) : 0);
                }

                // DÃ©tection Contexte (Tags sÃ©mantiques)
                if (lower.match(/sport|muscu|gym|courir|crossfit/)) { type = 'sport'; context = 'high_energy'; }
                else if (lower.match(/code|travail|deep|focus|Ã©tude|projet/)) { type = 'focus'; context = 'mental'; }
                else if (lower.match(/repas|dÃ©j|dÃ®ner|manger/)) { type = 'meal'; context = 'recovery'; }
                else if (lower.match(/lire|mÃ©diter|dÃ©tente|nap/)) { type = 'chill'; context = 'low_energy'; }

                return { title: text, duration, time, type, context };
            },

            // ALGORITHME D'OPTIMISATION TEMPORELLE
            findBestSlot(duration, context, existingTasks) {
                // Grille de la journÃ©e (en minutes, de 7h Ã  23h)
                let startLimit = App.state.config.morningStart * 60; 
                let endLimit = App.state.config.nightStart * 60;
                
                // Trier les tÃ¢ches existantes
                let occupied = existingTasks
                    .filter(t => t.time !== null)
                    .map(t => ({ start: t.time, end: t.time + t.duration }))
                    .sort((a,b) => a.start - b.start);

                // Chercher le premier trou ("gap") suffisant
                let currentTime = startLimit;
                
                // RÃ¨gle Contextuelle : Le Sport de prÃ©fÃ©rence le soir, Focus le matin
                if (context === 'high_energy') currentTime = Math.max(currentTime, 17 * 60); // 17h min pour sport
                if (context === 'mental') endLimit = 13 * 60; // Essayer de caler le focus avant 13h si possible (simplifiÃ©)

                for (let block of occupied) {
                    if (block.start - currentTime >= duration) {
                        return currentTime; // TrouvÃ© avant la prochaine tÃ¢che
                    }
                    currentTime = Math.max(currentTime, block.end + 15); // +15min buffer
                }

                // VÃ©rifier aprÃ¨s la derniÃ¨re tÃ¢che
                if (endLimit - currentTime >= duration) return currentTime;

                return null; // Pas de place
            },

            processBatch() {
                const input = document.getElementById('neuralInput');
                const raw = input.value;
                if (!raw.trim()) return;

                // Animation UI
                document.getElementById('aiGlow').classList.add('active');
                document.getElementById('aiStatus').innerText = "Analyse neurale...";

                setTimeout(() => {
                    const lines = raw.split('\n');
                    const dayKey = Utils.getDateKey(App.state.date);
                    if (!App.state.db[dayKey]) App.state.db[dayKey] = [];

                    lines.forEach(line => {
                        if (line.length < 3) return;
                        const intent = this.parseIntent(line);
                        
                        // Si pas d'heure, l'IA dÃ©cide
                        if (intent.time === null) {
                            const bestSlot = this.findBestSlot(intent.duration, intent.context, App.state.db[dayKey]);
                            if (bestSlot) {
                                intent.time = bestSlot;
                                intent.title += " (ðŸ¤– Auto)";
                            } else {
                                intent.time = 20 * 60; // Fallback 20h
                                intent.title += " (âš ï¸ Conflit)";
                            }
                        }
                        
                        App.state.db[dayKey].push({
                            id: Date.now() + Math.random(),
                            ...intent,
                            done: false
                        });
                    });

                    App.save();
                    input.value = "";
                    document.getElementById('aiGlow').classList.remove('active');
                    document.getElementById('aiStatus').innerText = "Optimisation terminÃ©e.";
                    setTimeout(() => document.getElementById('aiStatus').innerText = "En attente...", 2000);

                }, 800); // Fake processing delay for UX
            }
        };

        /**
         * --- 3. UI RENDERING SYSTEM ---
         */
        const UI = {
            toggleProfile(force = false) {
                const el = document.getElementById('profileModal');
                if (force) el.classList.remove('hidden');
                else el.classList.toggle('hidden');
            },

            render() {
                const key = Utils.getDateKey(App.state.date);
                const tasks = App.state.db[key] || [];
                
                // 1. Mise Ã  jour stats
                document.getElementById('currentDateDisplay').innerText = App.state.date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
                document.getElementById('waterVal').innerText = App.state.health.water + 'L';
                document.getElementById('waterBar').style.width = Math.min(100, (App.state.health.water / 2.5) * 100) + '%';

                // 2. Tri Chronologique
                tasks.sort((a, b) => a.time - b.time);

                // 3. Construction Timeline
                const container = document.getElementById('timelineContainer');
                container.innerHTML = '';
                
                if (tasks.length === 0) {
                    document.getElementById('emptyState').classList.remove('hidden');
                } else {
                    document.getElementById('emptyState').classList.add('hidden');
                    
                    // DÃ©tection du mode dominant
                    const sports = tasks.filter(t => t.type === 'sport').length;
                    const focus = tasks.filter(t => t.type === 'focus').length;
                    const badge = document.getElementById('contextBadge');
                    if(sports > focus) { badge.innerText = "MODE: ATHLÃˆTE"; badge.className = "text-[10px] px-2 py-1 bg-orange-500/20 text-orange-400 rounded border border-orange-500/50 font-mono"; }
                    else if(focus > sports) { badge.innerText = "MODE: DEEP WORK"; badge.className = "text-[10px] px-2 py-1 bg-purple-500/20 text-purple-400 rounded border border-purple-500/50 font-mono"; }
                    else { badge.innerText = "MODE: Ã‰QUILIBRE"; badge.className = "text-[10px] px-2 py-1 bg-green-500/20 text-green-400 rounded border border-green-500/50 font-mono"; }

                    tasks.forEach(task => {
                        const h = Math.floor(task.time / 60).toString().padStart(2, '0');
                        const m = (task.time % 60).toString().padStart(2, '0');
                        
                        // Styles dynamiques
                        let borderClass = 'border-white/10';
                        let dotColor = '#555';
                        if (task.type === 'sport') { borderClass = 'border-orange-500/50 bg-orange-500/5'; dotColor = '#f97316'; }
                        if (task.type === 'focus') { borderClass = 'border-purple-500/50 bg-purple-500/5'; dotColor = '#8b5cf6'; }
                        if (task.type === 'meal') { borderClass = 'border-green-500/50 bg-green-500/5'; dotColor = '#10b981'; }

                        const html = `
                        <div class="timeline-node">
                            <div class="node-time text-mono">${h}:${m}</div>
                            <div class="node-dot" style="background:${task.done ? dotColor : '#111'}; border-color:${dotColor}"></div>
                            <div class="card p-3 flex items-center justify-between group ${borderClass} ${task.done ? 'opacity-40 grayscale' : ''}" onclick="Data.toggleTask(${task.id})">
                                <div>
                                    <p class="font-bold text-sm ${task.done ? 'line-through' : ''}">${task.title}</p>
                                    <p class="text-[10px] opacity-50 font-mono uppercase">${task.duration} min â€¢ ${task.type}</p>
                                </div>
                                <button onclick="event.stopPropagation(); Data.deleteTask(${task.id})" class="opacity-0 group-hover:opacity-100 text-red-500 p-2">âœ•</button>
                            </div>
                        </div>`;
                        container.innerHTML += html;
                    });
                }
                
                // Render Calendar Strip
                this.renderCalendar();
            },

            renderCalendar() {
                const grid = document.getElementById('calendarGrid');
                grid.innerHTML = '';
                const today = new Date();
                for (let i = -2; i < 5; i++) {
                    const d = new Date();
                    d.setDate(today.getDate() + i);
                    const k = Utils.getDateKey(d);
                    const isSelected = k === Utils.getDateKey(App.state.date);
                    const hasData = App.state.db[k] && App.state.db[k].length > 0;
                    
                    const el = document.createElement('div');
                    el.className = `p-2 rounded-lg cursor-pointer transition ${isSelected ? 'bg-white text-black font-bold' : 'hover:bg-white/5'} ${hasData ? 'border-b-2 border-blue-500' : ''}`;
                    el.innerHTML = `<div class="opacity-50 text-[8px]">${['DIM','LUN','MAR','MER','JEU','VEN','SAM'][d.getDay()]}</div><div>${d.getDate()}</div>`;
                    el.onclick = () => { App.state.date = d; UI.render(); };
                    grid.appendChild(el);
                }
            },
            
            updateClock() {
                // Pourrait mettre Ã  jour une barre de progression temps rÃ©el ici
            }
        };

        /**
         * --- 4. DATA HELPERS ---
         */
        const Data = {
            saveProfile() {
                const name = document.getElementById('inputName').value;
                const w = document.getElementById('inputWeight').value;
                const h = document.getElementById('inputHeight').value;
                if(name && w && h) {
                    App.state.user = { name, w, h };
                    UI.toggleProfile();
                    App.save();
                }
            },
            addWater(qty) {
                App.state.health.water = parseFloat((App.state.health.water + qty).toFixed(2));
                App.save();
            },
            toggleTask(id) {
                const key = Utils.getDateKey(App.state.date);
                const t = App.state.db[key].find(x => x.id === id);
                if(t) t.done = !t.done;
                App.save();
            },
            deleteTask(id) {
                const key = Utils.getDateKey(App.state.date);
                App.state.db[key] = App.state.db[key].filter(x => x.id !== id);
                App.save();
            }
        };

        const Utils = {
            getDateKey(date) {
                return date.toISOString().split('T')[0];
            }
        };

        const System = {
            wipe() {
                if(confirm("SYSTEM OVERRIDE: RÃ©initialisation complÃ¨te ?")) {
                    localStorage.clear();
                    location.reload();
                }
            }
        };

        // BOOT
        App.init();

    </script>
</body>
</html>
